<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=emulateIE7" />
    <title>Coverage for /tmp/parts/odoo/addons/account/models/account_bank_statement.py: 22%</title>
    <link rel="icon" sizes="32x32" href="favicon_32.png">
    <link rel="stylesheet" href="style.css" type="text/css">
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jquery.hotkeys.js"></script>
    <script type="text/javascript" src="jquery.isonscreen.js"></script>
    <script type="text/javascript" src="coverage_html.js"></script>
    <script type="text/javascript">
        jQuery(document).ready(coverage.pyfile_ready);
    </script>
</head>
<body class="pyfile">
<div id="header">
    <div class="content">
        <h1>Coverage for <b>/tmp/parts/odoo/addons/account/models/account_bank_statement.py</b> :
            <span class="pc_cov">22%</span>
        </h1>
        <img id="keyboard_icon" src="keybd_closed.png" alt="Show keyboard shortcuts" />
        <h2 class="stats">
            563 statements &nbsp;
            <button type="button" class="run shortkey_r button_toggle_run" title="Toggle lines run">125 run</button>
            <button type="button" class="mis show_mis shortkey_m button_toggle_mis" title="Toggle lines missing">438 missing</button>
            <button type="button" class="exc show_exc shortkey_x button_toggle_exc" title="Toggle lines excluded">0 excluded</button>
        </h2>
    </div>
</div>
<div class="help_panel">
    <img id="panel_icon" src="keybd_open.png" alt="Hide keyboard shortcuts" />
    <p class="legend">Hot-keys on this page</p>
    <div>
    <p class="keyhelp">
        <span class="key">r</span>
        <span class="key">m</span>
        <span class="key">x</span>
        <span class="key">p</span> &nbsp; toggle line displays
    </p>
    <p class="keyhelp">
        <span class="key">j</span>
        <span class="key">k</span> &nbsp; next/prev highlighted chunk
    </p>
    <p class="keyhelp">
        <span class="key">0</span> &nbsp; (zero) top of page
    </p>
    <p class="keyhelp">
        <span class="key">1</span> &nbsp; (one) first highlighted chunk
    </p>
    </div>
</div>
<div id="source">
    <p id="t1" class="pln"><span class="n"><a href="#t1">1</a></span><span class="t"><span class="com"># -*- coding: utf-8 -*-</span>&nbsp;</span><span class="r"></span></p>
    <p id="t2" class="pln"><span class="n"><a href="#t2">2</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t3" class="run"><span class="n"><a href="#t3">3</a></span><span class="t"><span class="key">from</span> <span class="nam">odoo</span> <span class="key">import</span> <span class="nam">api</span><span class="op">,</span> <span class="nam">fields</span><span class="op">,</span> <span class="nam">models</span><span class="op">,</span> <span class="nam">_</span>&nbsp;</span><span class="r"></span></p>
    <p id="t4" class="run"><span class="n"><a href="#t4">4</a></span><span class="t"><span class="key">from</span> <span class="nam">odoo</span><span class="op">.</span><span class="nam">osv</span> <span class="key">import</span> <span class="nam">expression</span>&nbsp;</span><span class="r"></span></p>
    <p id="t5" class="run"><span class="n"><a href="#t5">5</a></span><span class="t"><span class="key">from</span> <span class="nam">odoo</span><span class="op">.</span><span class="nam">tools</span> <span class="key">import</span> <span class="nam">float_is_zero</span>&nbsp;</span><span class="r"></span></p>
    <p id="t6" class="run"><span class="n"><a href="#t6">6</a></span><span class="t"><span class="key">from</span> <span class="nam">odoo</span><span class="op">.</span><span class="nam">tools</span> <span class="key">import</span> <span class="nam">float_compare</span><span class="op">,</span> <span class="nam">float_round</span><span class="op">,</span> <span class="nam">float_repr</span>&nbsp;</span><span class="r"></span></p>
    <p id="t7" class="run"><span class="n"><a href="#t7">7</a></span><span class="t"><span class="key">from</span> <span class="nam">odoo</span><span class="op">.</span><span class="nam">tools</span><span class="op">.</span><span class="nam">misc</span> <span class="key">import</span> <span class="nam">formatLang</span>&nbsp;</span><span class="r"></span></p>
    <p id="t8" class="run"><span class="n"><a href="#t8">8</a></span><span class="t"><span class="key">from</span> <span class="nam">odoo</span><span class="op">.</span><span class="nam">exceptions</span> <span class="key">import</span> <span class="nam">UserError</span><span class="op">,</span> <span class="nam">ValidationError</span>&nbsp;</span><span class="r"></span></p>
    <p id="t9" class="pln"><span class="n"><a href="#t9">9</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t10" class="run"><span class="n"><a href="#t10">10</a></span><span class="t"><span class="key">import</span> <span class="nam">time</span>&nbsp;</span><span class="r"></span></p>
    <p id="t11" class="run"><span class="n"><a href="#t11">11</a></span><span class="t"><span class="key">import</span> <span class="nam">math</span>&nbsp;</span><span class="r"></span></p>
    <p id="t12" class="pln"><span class="n"><a href="#t12">12</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t13" class="run"><span class="n"><a href="#t13">13</a></span><span class="t"><span class="key">class</span> <span class="nam">AccountCashboxLine</span><span class="op">(</span><span class="nam">models</span><span class="op">.</span><span class="nam">Model</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t14" class="pln"><span class="n"><a href="#t14">14</a></span><span class="t">    <span class="str">""" Cash Box Details """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t15" class="run"><span class="n"><a href="#t15">15</a></span><span class="t">    <span class="nam">_name</span> <span class="op">=</span> <span class="str">'account.cashbox.line'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t16" class="run"><span class="n"><a href="#t16">16</a></span><span class="t">    <span class="nam">_description</span> <span class="op">=</span> <span class="str">'CashBox Line'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t17" class="run"><span class="n"><a href="#t17">17</a></span><span class="t">    <span class="nam">_rec_name</span> <span class="op">=</span> <span class="str">'coin_value'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t18" class="run"><span class="n"><a href="#t18">18</a></span><span class="t">    <span class="nam">_order</span> <span class="op">=</span> <span class="str">'coin_value'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t19" class="pln"><span class="n"><a href="#t19">19</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t20" class="run"><span class="n"><a href="#t20">20</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">one</span>&nbsp;</span><span class="r"></span></p>
    <p id="t21" class="run"><span class="n"><a href="#t21">21</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">depends</span><span class="op">(</span><span class="str">'coin_value'</span><span class="op">,</span> <span class="str">'number'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t22" class="pln"><span class="n"><a href="#t22">22</a></span><span class="t">    <span class="key">def</span> <span class="nam">_sub_total</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t23" class="pln"><span class="n"><a href="#t23">23</a></span><span class="t">        <span class="str">""" Calculates Sub total"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t24" class="mis show_mis"><span class="n"><a href="#t24">24</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">subtotal</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">coin_value</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">number</span>&nbsp;</span><span class="r"></span></p>
    <p id="t25" class="pln"><span class="n"><a href="#t25">25</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t26" class="run"><span class="n"><a href="#t26">26</a></span><span class="t">    <span class="nam">coin_value</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Float</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Coin/Bill Value'</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">digits</span><span class="op">=</span><span class="num">0</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t27" class="run"><span class="n"><a href="#t27">27</a></span><span class="t">    <span class="nam">number</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Integer</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Number of Coins/Bills'</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">'Opening Unit Numbers'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t28" class="run"><span class="n"><a href="#t28">28</a></span><span class="t">    <span class="nam">subtotal</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Float</span><span class="op">(</span><span class="nam">compute</span><span class="op">=</span><span class="str">'_sub_total'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Subtotal'</span><span class="op">,</span> <span class="nam">digits</span><span class="op">=</span><span class="num">0</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t29" class="run"><span class="n"><a href="#t29">29</a></span><span class="t">    <span class="nam">cashbox_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.bank.statement.cashbox'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">"Cashbox"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t30" class="pln"><span class="n"><a href="#t30">30</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t31" class="pln"><span class="n"><a href="#t31">31</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t32" class="run"><span class="n"><a href="#t32">32</a></span><span class="t"><span class="key">class</span> <span class="nam">AccountBankStmtCashWizard</span><span class="op">(</span><span class="nam">models</span><span class="op">.</span><span class="nam">Model</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t33" class="pln"><span class="n"><a href="#t33">33</a></span><span class="t">    <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t34" class="pln"><span class="n"><a href="#t34">34</a></span><span class="t"><span class="str">    Account Bank Statement popup that allows entering cash details.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t35" class="pln"><span class="n"><a href="#t35">35</a></span><span class="t"><span class="str">    """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t36" class="run"><span class="n"><a href="#t36">36</a></span><span class="t">    <span class="nam">_name</span> <span class="op">=</span> <span class="str">'account.bank.statement.cashbox'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t37" class="run"><span class="n"><a href="#t37">37</a></span><span class="t">    <span class="nam">_description</span> <span class="op">=</span> <span class="str">'Account Bank Statement Cashbox Details'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t38" class="pln"><span class="n"><a href="#t38">38</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t39" class="run"><span class="n"><a href="#t39">39</a></span><span class="t">    <span class="nam">cashbox_lines_ids</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">One2many</span><span class="op">(</span><span class="str">'account.cashbox.line'</span><span class="op">,</span> <span class="str">'cashbox_id'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Cashbox Lines'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t40" class="pln"><span class="n"><a href="#t40">40</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t41" class="run"><span class="n"><a href="#t41">41</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t42" class="pln"><span class="n"><a href="#t42">42</a></span><span class="t">    <span class="key">def</span> <span class="nam">validate</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t43" class="mis show_mis"><span class="n"><a href="#t43">43</a></span><span class="t">        <span class="nam">bnk_stmt_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">context</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'bank_statement_id'</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">context</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'active_id'</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t44" class="mis show_mis"><span class="n"><a href="#t44">44</a></span><span class="t">        <span class="nam">bnk_stmt</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.bank.statement'</span><span class="op">]</span><span class="op">.</span><span class="nam">browse</span><span class="op">(</span><span class="nam">bnk_stmt_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t45" class="mis show_mis"><span class="n"><a href="#t45">45</a></span><span class="t">        <span class="nam">total</span> <span class="op">=</span> <span class="num">0.0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t46" class="mis show_mis"><span class="n"><a href="#t46">46</a></span><span class="t">        <span class="key">for</span> <span class="nam">lines</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">cashbox_lines_ids</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t47" class="mis show_mis"><span class="n"><a href="#t47">47</a></span><span class="t">            <span class="nam">total</span> <span class="op">+=</span> <span class="nam">lines</span><span class="op">.</span><span class="nam">subtotal</span>&nbsp;</span><span class="r"></span></p>
    <p id="t48" class="mis show_mis"><span class="n"><a href="#t48">48</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">context</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'balance'</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span> <span class="op">==</span> <span class="str">'start'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t49" class="pln"><span class="n"><a href="#t49">49</a></span><span class="t">            <span class="com">#starting balance</span>&nbsp;</span><span class="r"></span></p>
    <p id="t50" class="mis show_mis"><span class="n"><a href="#t50">50</a></span><span class="t">            <span class="nam">bnk_stmt</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'balance_start'</span><span class="op">:</span> <span class="nam">total</span><span class="op">,</span> <span class="str">'cashbox_start_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">id</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t51" class="pln"><span class="n"><a href="#t51">51</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t52" class="pln"><span class="n"><a href="#t52">52</a></span><span class="t">            <span class="com">#closing balance</span>&nbsp;</span><span class="r"></span></p>
    <p id="t53" class="mis show_mis"><span class="n"><a href="#t53">53</a></span><span class="t">            <span class="nam">bnk_stmt</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'balance_end_real'</span><span class="op">:</span> <span class="nam">total</span><span class="op">,</span> <span class="str">'cashbox_end_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">id</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t54" class="mis show_mis"><span class="n"><a href="#t54">54</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span><span class="str">'type'</span><span class="op">:</span> <span class="str">'ir.actions.act_window_close'</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t55" class="pln"><span class="n"><a href="#t55">55</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t56" class="pln"><span class="n"><a href="#t56">56</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t57" class="run"><span class="n"><a href="#t57">57</a></span><span class="t"><span class="key">class</span> <span class="nam">AccountBankStmtCloseCheck</span><span class="op">(</span><span class="nam">models</span><span class="op">.</span><span class="nam">TransientModel</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t58" class="pln"><span class="n"><a href="#t58">58</a></span><span class="t">    <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t59" class="pln"><span class="n"><a href="#t59">59</a></span><span class="t"><span class="str">    Account Bank Statement wizard that check that closing balance is correct.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t60" class="pln"><span class="n"><a href="#t60">60</a></span><span class="t"><span class="str">    """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t61" class="run"><span class="n"><a href="#t61">61</a></span><span class="t">    <span class="nam">_name</span> <span class="op">=</span> <span class="str">'account.bank.statement.closebalance'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t62" class="run"><span class="n"><a href="#t62">62</a></span><span class="t">    <span class="nam">_description</span> <span class="op">=</span> <span class="str">'Account Bank Statement closing balance'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t63" class="pln"><span class="n"><a href="#t63">63</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t64" class="run"><span class="n"><a href="#t64">64</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t65" class="pln"><span class="n"><a href="#t65">65</a></span><span class="t">    <span class="key">def</span> <span class="nam">validate</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t66" class="mis show_mis"><span class="n"><a href="#t66">66</a></span><span class="t">        <span class="nam">bnk_stmt_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">context</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'active_id'</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t67" class="mis show_mis"><span class="n"><a href="#t67">67</a></span><span class="t">        <span class="key">if</span> <span class="nam">bnk_stmt_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t68" class="mis show_mis"><span class="n"><a href="#t68">68</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.bank.statement'</span><span class="op">]</span><span class="op">.</span><span class="nam">browse</span><span class="op">(</span><span class="nam">bnk_stmt_id</span><span class="op">)</span><span class="op">.</span><span class="nam">button_confirm_bank</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t69" class="mis show_mis"><span class="n"><a href="#t69">69</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span><span class="str">'type'</span><span class="op">:</span> <span class="str">'ir.actions.act_window_close'</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t70" class="pln"><span class="n"><a href="#t70">70</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t71" class="pln"><span class="n"><a href="#t71">71</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t72" class="run"><span class="n"><a href="#t72">72</a></span><span class="t"><span class="key">class</span> <span class="nam">AccountBankStatement</span><span class="op">(</span><span class="nam">models</span><span class="op">.</span><span class="nam">Model</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t73" class="pln"><span class="n"><a href="#t73">73</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t74" class="run"><span class="n"><a href="#t74">74</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">one</span>&nbsp;</span><span class="r"></span></p>
    <p id="t75" class="run"><span class="n"><a href="#t75">75</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">depends</span><span class="op">(</span><span class="str">'line_ids'</span><span class="op">,</span> <span class="str">'balance_start'</span><span class="op">,</span> <span class="str">'line_ids.amount'</span><span class="op">,</span> <span class="str">'balance_end_real'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t76" class="pln"><span class="n"><a href="#t76">76</a></span><span class="t">    <span class="key">def</span> <span class="nam">_end_balance</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t77" class="mis show_mis"><span class="n"><a href="#t77">77</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">total_entry_encoding</span> <span class="op">=</span> <span class="nam">sum</span><span class="op">(</span><span class="op">[</span><span class="nam">line</span><span class="op">.</span><span class="nam">amount</span> <span class="key">for</span> <span class="nam">line</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t78" class="mis show_mis"><span class="n"><a href="#t78">78</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">balance_end</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">balance_start</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">total_entry_encoding</span>&nbsp;</span><span class="r"></span></p>
    <p id="t79" class="mis show_mis"><span class="n"><a href="#t79">79</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">difference</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">balance_end_real</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">balance_end</span>&nbsp;</span><span class="r"></span></p>
    <p id="t80" class="pln"><span class="n"><a href="#t80">80</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t81" class="run"><span class="n"><a href="#t81">81</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t82" class="pln"><span class="n"><a href="#t82">82</a></span><span class="t">    <span class="key">def</span> <span class="nam">_is_difference_zero</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t83" class="mis show_mis"><span class="n"><a href="#t83">83</a></span><span class="t">        <span class="key">for</span> <span class="nam">bank_stmt</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t84" class="mis show_mis"><span class="n"><a href="#t84">84</a></span><span class="t">            <span class="nam">bank_stmt</span><span class="op">.</span><span class="nam">is_difference_zero</span> <span class="op">=</span> <span class="nam">float_is_zero</span><span class="op">(</span><span class="nam">bank_stmt</span><span class="op">.</span><span class="nam">difference</span><span class="op">,</span> <span class="nam">precision_digits</span><span class="op">=</span><span class="nam">bank_stmt</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">decimal_places</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t85" class="pln"><span class="n"><a href="#t85">85</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t86" class="run"><span class="n"><a href="#t86">86</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">one</span>&nbsp;</span><span class="r"></span></p>
    <p id="t87" class="run"><span class="n"><a href="#t87">87</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">depends</span><span class="op">(</span><span class="str">'journal_id'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t88" class="pln"><span class="n"><a href="#t88">88</a></span><span class="t">    <span class="key">def</span> <span class="nam">_compute_currency</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t89" class="mis show_mis"><span class="n"><a href="#t89">89</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t90" class="pln"><span class="n"><a href="#t90">90</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t91" class="run"><span class="n"><a href="#t91">91</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">one</span>&nbsp;</span><span class="r"></span></p>
    <p id="t92" class="run"><span class="n"><a href="#t92">92</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">depends</span><span class="op">(</span><span class="str">'line_ids.journal_entry_ids'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t93" class="pln"><span class="n"><a href="#t93">93</a></span><span class="t">    <span class="key">def</span> <span class="nam">_check_lines_reconciled</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t94" class="mis show_mis"><span class="n"><a href="#t94">94</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">all_lines_reconciled</span> <span class="op">=</span> <span class="nam">all</span><span class="op">(</span><span class="op">[</span><span class="nam">line</span><span class="op">.</span><span class="nam">journal_entry_ids</span><span class="op">.</span><span class="nam">ids</span> <span class="key">or</span> <span class="nam">line</span><span class="op">.</span><span class="nam">account_id</span><span class="op">.</span><span class="nam">id</span> <span class="key">for</span> <span class="nam">line</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t95" class="pln"><span class="n"><a href="#t95">95</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t96" class="run"><span class="n"><a href="#t96">96</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">model</span>&nbsp;</span><span class="r"></span></p>
    <p id="t97" class="pln"><span class="n"><a href="#t97">97</a></span><span class="t">    <span class="key">def</span> <span class="nam">_default_journal</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t98" class="mis show_mis"><span class="n"><a href="#t98">98</a></span><span class="t">        <span class="nam">journal_type</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">context</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'journal_type'</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t99" class="mis show_mis"><span class="n"><a href="#t99">99</a></span><span class="t">        <span class="nam">company_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'res.company'</span><span class="op">]</span><span class="op">.</span><span class="nam">_company_default_get</span><span class="op">(</span><span class="str">'account.bank.statement'</span><span class="op">)</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t100" class="mis show_mis"><span class="n"><a href="#t100">100</a></span><span class="t">        <span class="key">if</span> <span class="nam">journal_type</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t101" class="mis show_mis"><span class="n"><a href="#t101">101</a></span><span class="t">            <span class="nam">journals</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.journal'</span><span class="op">]</span><span class="op">.</span><span class="nam">search</span><span class="op">(</span><span class="op">[</span><span class="op">(</span><span class="str">'type'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">journal_type</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'company_id'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">company_id</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t102" class="mis show_mis"><span class="n"><a href="#t102">102</a></span><span class="t">            <span class="key">if</span> <span class="nam">journals</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t103" class="mis show_mis"><span class="n"><a href="#t103">103</a></span><span class="t">                <span class="key">return</span> <span class="nam">journals</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t104" class="mis show_mis"><span class="n"><a href="#t104">104</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.journal'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t105" class="pln"><span class="n"><a href="#t105">105</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t106" class="run"><span class="n"><a href="#t106">106</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t107" class="pln"><span class="n"><a href="#t107">107</a></span><span class="t">    <span class="key">def</span> <span class="nam">_get_opening_balance</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">journal_id</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t108" class="mis show_mis"><span class="n"><a href="#t108">108</a></span><span class="t">        <span class="nam">last_bnk_stmt</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">search</span><span class="op">(</span><span class="op">[</span><span class="op">(</span><span class="str">'journal_id'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">journal_id</span><span class="op">)</span><span class="op">]</span><span class="op">,</span> <span class="nam">limit</span><span class="op">=</span><span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t109" class="mis show_mis"><span class="n"><a href="#t109">109</a></span><span class="t">        <span class="key">if</span> <span class="nam">last_bnk_stmt</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t110" class="mis show_mis"><span class="n"><a href="#t110">110</a></span><span class="t">            <span class="key">return</span> <span class="nam">last_bnk_stmt</span><span class="op">.</span><span class="nam">balance_end</span>&nbsp;</span><span class="r"></span></p>
    <p id="t111" class="mis show_mis"><span class="n"><a href="#t111">111</a></span><span class="t">        <span class="key">return</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t112" class="pln"><span class="n"><a href="#t112">112</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t113" class="run"><span class="n"><a href="#t113">113</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t114" class="pln"><span class="n"><a href="#t114">114</a></span><span class="t">    <span class="key">def</span> <span class="nam">_set_opening_balance</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">journal_id</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t115" class="mis show_mis"><span class="n"><a href="#t115">115</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">balance_start</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_opening_balance</span><span class="op">(</span><span class="nam">journal_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t116" class="pln"><span class="n"><a href="#t116">116</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t117" class="run"><span class="n"><a href="#t117">117</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">model</span>&nbsp;</span><span class="r"></span></p>
    <p id="t118" class="pln"><span class="n"><a href="#t118">118</a></span><span class="t">    <span class="key">def</span> <span class="nam">_default_opening_balance</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t119" class="pln"><span class="n"><a href="#t119">119</a></span><span class="t">        <span class="com">#Search last bank statement and set current opening balance as closing balance of previous one</span>&nbsp;</span><span class="r"></span></p>
    <p id="t120" class="mis show_mis"><span class="n"><a href="#t120">120</a></span><span class="t">        <span class="nam">journal_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_context</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'default_journal_id'</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_context</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'journal_id'</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t121" class="mis show_mis"><span class="n"><a href="#t121">121</a></span><span class="t">        <span class="key">if</span> <span class="nam">journal_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t122" class="mis show_mis"><span class="n"><a href="#t122">122</a></span><span class="t">            <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_opening_balance</span><span class="op">(</span><span class="nam">journal_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t123" class="mis show_mis"><span class="n"><a href="#t123">123</a></span><span class="t">        <span class="key">return</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t124" class="pln"><span class="n"><a href="#t124">124</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t125" class="run"><span class="n"><a href="#t125">125</a></span><span class="t">    <span class="nam">_name</span> <span class="op">=</span> <span class="str">"account.bank.statement"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t126" class="run"><span class="n"><a href="#t126">126</a></span><span class="t">    <span class="nam">_description</span> <span class="op">=</span> <span class="str">"Bank Statement"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t127" class="run"><span class="n"><a href="#t127">127</a></span><span class="t">    <span class="nam">_order</span> <span class="op">=</span> <span class="str">"date desc, id desc"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t128" class="run"><span class="n"><a href="#t128">128</a></span><span class="t">    <span class="nam">_inherit</span> <span class="op">=</span> <span class="op">[</span><span class="str">'mail.thread'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t129" class="pln"><span class="n"><a href="#t129">129</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t130" class="run"><span class="n"><a href="#t130">130</a></span><span class="t">    <span class="nam">name</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Reference'</span><span class="op">,</span> <span class="nam">states</span><span class="op">=</span><span class="op">{</span><span class="str">'open'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="str">'readonly'</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span><span class="op">]</span><span class="op">}</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t131" class="run"><span class="n"><a href="#t131">131</a></span><span class="t">    <span class="nam">reference</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'External Reference'</span><span class="op">,</span> <span class="nam">states</span><span class="op">=</span><span class="op">{</span><span class="str">'open'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="str">'readonly'</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span><span class="op">]</span><span class="op">}</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">"Used to hold the reference of the external mean that created this statement (name of imported file, reference of online synchronization...)"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t132" class="run"><span class="n"><a href="#t132">132</a></span><span class="t">    <span class="nam">date</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Date</span><span class="op">(</span><span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">states</span><span class="op">=</span><span class="op">{</span><span class="str">'confirm'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="str">'readonly'</span><span class="op">,</span> <span class="nam">True</span><span class="op">)</span><span class="op">]</span><span class="op">}</span><span class="op">,</span> <span class="nam">index</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="nam">fields</span><span class="op">.</span><span class="nam">Date</span><span class="op">.</span><span class="nam">context_today</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t133" class="run"><span class="n"><a href="#t133">133</a></span><span class="t">    <span class="nam">date_done</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Datetime</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">"Closed On"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t134" class="run"><span class="n"><a href="#t134">134</a></span><span class="t">    <span class="nam">balance_start</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Monetary</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Starting Balance'</span><span class="op">,</span> <span class="nam">states</span><span class="op">=</span><span class="op">{</span><span class="str">'confirm'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="str">'readonly'</span><span class="op">,</span> <span class="nam">True</span><span class="op">)</span><span class="op">]</span><span class="op">}</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="nam">_default_opening_balance</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t135" class="run"><span class="n"><a href="#t135">135</a></span><span class="t">    <span class="nam">balance_end_real</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Monetary</span><span class="op">(</span><span class="str">'Ending Balance'</span><span class="op">,</span> <span class="nam">states</span><span class="op">=</span><span class="op">{</span><span class="str">'confirm'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="str">'readonly'</span><span class="op">,</span> <span class="nam">True</span><span class="op">)</span><span class="op">]</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t136" class="run"><span class="n"><a href="#t136">136</a></span><span class="t">    <span class="nam">state</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Selection</span><span class="op">(</span><span class="op">[</span><span class="op">(</span><span class="str">'open'</span><span class="op">,</span> <span class="str">'New'</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'confirm'</span><span class="op">,</span> <span class="str">'Validated'</span><span class="op">)</span><span class="op">]</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Status'</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="str">'open'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t137" class="run"><span class="n"><a href="#t137">137</a></span><span class="t">    <span class="nam">currency_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'res.currency'</span><span class="op">,</span> <span class="nam">compute</span><span class="op">=</span><span class="str">'_compute_currency'</span><span class="op">,</span> <span class="nam">oldname</span><span class="op">=</span><span class="str">'currency'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">"Currency"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t138" class="run"><span class="n"><a href="#t138">138</a></span><span class="t">    <span class="nam">journal_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.journal'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Journal'</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">states</span><span class="op">=</span><span class="op">{</span><span class="str">'confirm'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="str">'readonly'</span><span class="op">,</span> <span class="nam">True</span><span class="op">)</span><span class="op">]</span><span class="op">}</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="nam">_default_journal</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t139" class="run"><span class="n"><a href="#t139">139</a></span><span class="t">    <span class="nam">journal_type</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Selection</span><span class="op">(</span><span class="nam">related</span><span class="op">=</span><span class="str">'journal_id.type'</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">"Technical field used for usability purposes"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t140" class="run"><span class="n"><a href="#t140">140</a></span><span class="t">    <span class="nam">company_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'res.company'</span><span class="op">,</span> <span class="nam">related</span><span class="op">=</span><span class="str">'journal_id.company_id'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Company'</span><span class="op">,</span> <span class="nam">store</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t141" class="pln"><span class="n"><a href="#t141">141</a></span><span class="t">        <span class="nam">default</span><span class="op">=</span><span class="key">lambda</span> <span class="nam">self</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'res.company'</span><span class="op">]</span><span class="op">.</span><span class="nam">_company_default_get</span><span class="op">(</span><span class="str">'account.bank.statement'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t142" class="pln"><span class="n"><a href="#t142">142</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t143" class="run"><span class="n"><a href="#t143">143</a></span><span class="t">    <span class="nam">total_entry_encoding</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Monetary</span><span class="op">(</span><span class="str">'Transactions Subtotal'</span><span class="op">,</span> <span class="nam">compute</span><span class="op">=</span><span class="str">'_end_balance'</span><span class="op">,</span> <span class="nam">store</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">"Total of transaction lines."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t144" class="run"><span class="n"><a href="#t144">144</a></span><span class="t">    <span class="nam">balance_end</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Monetary</span><span class="op">(</span><span class="str">'Computed Balance'</span><span class="op">,</span> <span class="nam">compute</span><span class="op">=</span><span class="str">'_end_balance'</span><span class="op">,</span> <span class="nam">store</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">'Balance as calculated based on Opening Balance and transaction lines'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t145" class="run"><span class="n"><a href="#t145">145</a></span><span class="t">    <span class="nam">difference</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Monetary</span><span class="op">(</span><span class="nam">compute</span><span class="op">=</span><span class="str">'_end_balance'</span><span class="op">,</span> <span class="nam">store</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">"Difference between the computed ending balance and the specified ending balance."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t146" class="pln"><span class="n"><a href="#t146">146</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t147" class="run"><span class="n"><a href="#t147">147</a></span><span class="t">    <span class="nam">line_ids</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">One2many</span><span class="op">(</span><span class="str">'account.bank.statement.line'</span><span class="op">,</span> <span class="str">'statement_id'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Statement lines'</span><span class="op">,</span> <span class="nam">states</span><span class="op">=</span><span class="op">{</span><span class="str">'confirm'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="str">'readonly'</span><span class="op">,</span> <span class="nam">True</span><span class="op">)</span><span class="op">]</span><span class="op">}</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t148" class="run"><span class="n"><a href="#t148">148</a></span><span class="t">    <span class="nam">move_line_ids</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">One2many</span><span class="op">(</span><span class="str">'account.move.line'</span><span class="op">,</span> <span class="str">'statement_id'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Entry lines'</span><span class="op">,</span> <span class="nam">states</span><span class="op">=</span><span class="op">{</span><span class="str">'confirm'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="str">'readonly'</span><span class="op">,</span> <span class="nam">True</span><span class="op">)</span><span class="op">]</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t149" class="run"><span class="n"><a href="#t149">149</a></span><span class="t">    <span class="nam">all_lines_reconciled</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Boolean</span><span class="op">(</span><span class="nam">compute</span><span class="op">=</span><span class="str">'_check_lines_reconciled'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t150" class="run"><span class="n"><a href="#t150">150</a></span><span class="t">    <span class="nam">user_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'res.users'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Responsible'</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="key">lambda</span> <span class="nam">self</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">user</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t151" class="run"><span class="n"><a href="#t151">151</a></span><span class="t">    <span class="nam">cashbox_start_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.bank.statement.cashbox'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">"Starting Cashbox"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t152" class="run"><span class="n"><a href="#t152">152</a></span><span class="t">    <span class="nam">cashbox_end_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.bank.statement.cashbox'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">"Ending Cashbox"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t153" class="run"><span class="n"><a href="#t153">153</a></span><span class="t">    <span class="nam">is_difference_zero</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Boolean</span><span class="op">(</span><span class="nam">compute</span><span class="op">=</span><span class="str">'_is_difference_zero'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Is zero'</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">"Check if difference is zero."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t154" class="pln"><span class="n"><a href="#t154">154</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t155" class="run"><span class="n"><a href="#t155">155</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">onchange</span><span class="op">(</span><span class="str">'journal_id'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t156" class="pln"><span class="n"><a href="#t156">156</a></span><span class="t">    <span class="key">def</span> <span class="nam">onchange_journal_id</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t157" class="mis show_mis"><span class="n"><a href="#t157">157</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">_set_opening_balance</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t158" class="pln"><span class="n"><a href="#t158">158</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t159" class="run"><span class="n"><a href="#t159">159</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t160" class="pln"><span class="n"><a href="#t160">160</a></span><span class="t">    <span class="key">def</span> <span class="nam">_balance_check</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t161" class="mis show_mis"><span class="n"><a href="#t161">161</a></span><span class="t">        <span class="key">for</span> <span class="nam">stmt</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t162" class="mis show_mis"><span class="n"><a href="#t162">162</a></span><span class="t">            <span class="key">if</span> <span class="key">not</span> <span class="nam">stmt</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">is_zero</span><span class="op">(</span><span class="nam">stmt</span><span class="op">.</span><span class="nam">difference</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t163" class="mis show_mis"><span class="n"><a href="#t163">163</a></span><span class="t">                <span class="key">if</span> <span class="nam">stmt</span><span class="op">.</span><span class="nam">journal_type</span> <span class="op">==</span> <span class="str">'cash'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t164" class="mis show_mis"><span class="n"><a href="#t164">164</a></span><span class="t">                    <span class="key">if</span> <span class="nam">stmt</span><span class="op">.</span><span class="nam">difference</span> <span class="op">&lt;</span> <span class="num">0.0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t165" class="mis show_mis"><span class="n"><a href="#t165">165</a></span><span class="t">                        <span class="nam">account</span> <span class="op">=</span> <span class="nam">stmt</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">loss_account_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t166" class="mis show_mis"><span class="n"><a href="#t166">166</a></span><span class="t">                        <span class="nam">name</span> <span class="op">=</span> <span class="nam">_</span><span class="op">(</span><span class="str">'Loss'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t167" class="pln"><span class="n"><a href="#t167">167</a></span><span class="t">                    <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t168" class="pln"><span class="n"><a href="#t168">168</a></span><span class="t">                        <span class="com"># statement.difference > 0.0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t169" class="mis show_mis"><span class="n"><a href="#t169">169</a></span><span class="t">                        <span class="nam">account</span> <span class="op">=</span> <span class="nam">stmt</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">profit_account_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t170" class="mis show_mis"><span class="n"><a href="#t170">170</a></span><span class="t">                        <span class="nam">name</span> <span class="op">=</span> <span class="nam">_</span><span class="op">(</span><span class="str">'Profit'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t171" class="mis show_mis"><span class="n"><a href="#t171">171</a></span><span class="t">                    <span class="key">if</span> <span class="key">not</span> <span class="nam">account</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t172" class="mis show_mis"><span class="n"><a href="#t172">172</a></span><span class="t">                        <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'There is no account defined on the journal %s for %s involved in a cash difference.'</span><span class="op">)</span> <span class="op">%</span> <span class="op">(</span><span class="nam">stmt</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">name</span><span class="op">,</span> <span class="nam">name</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t173" class="pln"><span class="n"><a href="#t173">173</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t174" class="mis show_mis"><span class="n"><a href="#t174">174</a></span><span class="t">                    <span class="nam">values</span> <span class="op">=</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t175" class="pln"><span class="n"><a href="#t175">175</a></span><span class="t">                        <span class="str">'statement_id'</span><span class="op">:</span> <span class="nam">stmt</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t176" class="pln"><span class="n"><a href="#t176">176</a></span><span class="t">                        <span class="str">'account_id'</span><span class="op">:</span> <span class="nam">account</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t177" class="pln"><span class="n"><a href="#t177">177</a></span><span class="t">                        <span class="str">'amount'</span><span class="op">:</span> <span class="nam">stmt</span><span class="op">.</span><span class="nam">difference</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t178" class="pln"><span class="n"><a href="#t178">178</a></span><span class="t">                        <span class="str">'name'</span><span class="op">:</span> <span class="nam">_</span><span class="op">(</span><span class="str">"Cash difference observed during the counting (%s)"</span><span class="op">)</span> <span class="op">%</span> <span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t179" class="pln"><span class="n"><a href="#t179">179</a></span><span class="t">                    <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t180" class="mis show_mis"><span class="n"><a href="#t180">180</a></span><span class="t">                    <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.bank.statement.line'</span><span class="op">]</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="nam">values</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t181" class="pln"><span class="n"><a href="#t181">181</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t182" class="mis show_mis"><span class="n"><a href="#t182">182</a></span><span class="t">                    <span class="nam">balance_end_real</span> <span class="op">=</span> <span class="nam">formatLang</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">,</span> <span class="nam">stmt</span><span class="op">.</span><span class="nam">balance_end_real</span><span class="op">,</span> <span class="nam">currency_obj</span><span class="op">=</span><span class="nam">stmt</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t183" class="mis show_mis"><span class="n"><a href="#t183">183</a></span><span class="t">                    <span class="nam">balance_end</span> <span class="op">=</span> <span class="nam">formatLang</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">,</span> <span class="nam">stmt</span><span class="op">.</span><span class="nam">balance_end</span><span class="op">,</span> <span class="nam">currency_obj</span><span class="op">=</span><span class="nam">stmt</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t184" class="mis show_mis"><span class="n"><a href="#t184">184</a></span><span class="t">                    <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'The ending balance is incorrect !\nThe expected balance (%s) is different from the computed one. (%s)'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t185" class="pln"><span class="n"><a href="#t185">185</a></span><span class="t">                        <span class="op">%</span> <span class="op">(</span><span class="nam">balance_end_real</span><span class="op">,</span> <span class="nam">balance_end</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t186" class="mis show_mis"><span class="n"><a href="#t186">186</a></span><span class="t">        <span class="key">return</span> <span class="nam">True</span>&nbsp;</span><span class="r"></span></p>
    <p id="t187" class="pln"><span class="n"><a href="#t187">187</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t188" class="run"><span class="n"><a href="#t188">188</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t189" class="pln"><span class="n"><a href="#t189">189</a></span><span class="t">    <span class="key">def</span> <span class="nam">unlink</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t190" class="mis show_mis"><span class="n"><a href="#t190">190</a></span><span class="t">        <span class="key">for</span> <span class="nam">statement</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t191" class="mis show_mis"><span class="n"><a href="#t191">191</a></span><span class="t">            <span class="key">if</span> <span class="nam">statement</span><span class="op">.</span><span class="nam">state</span> <span class="op">!=</span> <span class="str">'open'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t192" class="mis show_mis"><span class="n"><a href="#t192">192</a></span><span class="t">                <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'In order to delete a bank statement, you must first cancel it to delete related journal items.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t193" class="pln"><span class="n"><a href="#t193">193</a></span><span class="t">            <span class="com"># Explicitly unlink bank statement lines so it will check that the related journal entries have been deleted first</span>&nbsp;</span><span class="r"></span></p>
    <p id="t194" class="mis show_mis"><span class="n"><a href="#t194">194</a></span><span class="t">            <span class="nam">statement</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">.</span><span class="nam">unlink</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t195" class="mis show_mis"><span class="n"><a href="#t195">195</a></span><span class="t">        <span class="key">return</span> <span class="nam">super</span><span class="op">(</span><span class="nam">AccountBankStatement</span><span class="op">,</span> <span class="nam">self</span><span class="op">)</span><span class="op">.</span><span class="nam">unlink</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t196" class="pln"><span class="n"><a href="#t196">196</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t197" class="run"><span class="n"><a href="#t197">197</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t198" class="pln"><span class="n"><a href="#t198">198</a></span><span class="t">    <span class="key">def</span> <span class="nam">open_cashbox_id</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t199" class="mis show_mis"><span class="n"><a href="#t199">199</a></span><span class="t">        <span class="nam">context</span> <span class="op">=</span> <span class="nam">dict</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">context</span> <span class="key">or</span> <span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t200" class="mis show_mis"><span class="n"><a href="#t200">200</a></span><span class="t">        <span class="key">if</span> <span class="nam">context</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'cashbox_id'</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t201" class="mis show_mis"><span class="n"><a href="#t201">201</a></span><span class="t">            <span class="nam">context</span><span class="op">[</span><span class="str">'active_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t202" class="mis show_mis"><span class="n"><a href="#t202">202</a></span><span class="t">            <span class="key">return</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t203" class="pln"><span class="n"><a href="#t203">203</a></span><span class="t">                <span class="str">'name'</span><span class="op">:</span> <span class="nam">_</span><span class="op">(</span><span class="str">'Cash Control'</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t204" class="pln"><span class="n"><a href="#t204">204</a></span><span class="t">                <span class="str">'view_type'</span><span class="op">:</span> <span class="str">'form'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t205" class="pln"><span class="n"><a href="#t205">205</a></span><span class="t">                <span class="str">'view_mode'</span><span class="op">:</span> <span class="str">'form'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t206" class="pln"><span class="n"><a href="#t206">206</a></span><span class="t">                <span class="str">'res_model'</span><span class="op">:</span> <span class="str">'account.bank.statement.cashbox'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t207" class="pln"><span class="n"><a href="#t207">207</a></span><span class="t">                <span class="str">'view_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">ref</span><span class="op">(</span><span class="str">'account.view_account_bnk_stmt_cashbox'</span><span class="op">)</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t208" class="pln"><span class="n"><a href="#t208">208</a></span><span class="t">                <span class="str">'type'</span><span class="op">:</span> <span class="str">'ir.actions.act_window'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t209" class="pln"><span class="n"><a href="#t209">209</a></span><span class="t">                <span class="str">'res_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">context</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'cashbox_id'</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t210" class="pln"><span class="n"><a href="#t210">210</a></span><span class="t">                <span class="str">'context'</span><span class="op">:</span> <span class="nam">context</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t211" class="pln"><span class="n"><a href="#t211">211</a></span><span class="t">                <span class="str">'target'</span><span class="op">:</span> <span class="str">'new'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t212" class="pln"><span class="n"><a href="#t212">212</a></span><span class="t">            <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t213" class="pln"><span class="n"><a href="#t213">213</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t214" class="run"><span class="n"><a href="#t214">214</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t215" class="pln"><span class="n"><a href="#t215">215</a></span><span class="t">    <span class="key">def</span> <span class="nam">button_cancel</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t216" class="mis show_mis"><span class="n"><a href="#t216">216</a></span><span class="t">        <span class="key">for</span> <span class="nam">statement</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t217" class="mis show_mis"><span class="n"><a href="#t217">217</a></span><span class="t">            <span class="key">if</span> <span class="nam">any</span><span class="op">(</span><span class="nam">line</span><span class="op">.</span><span class="nam">journal_entry_ids</span><span class="op">.</span><span class="nam">ids</span> <span class="key">for</span> <span class="nam">line</span> <span class="key">in</span> <span class="nam">statement</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t218" class="mis show_mis"><span class="n"><a href="#t218">218</a></span><span class="t">                <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'A statement cannot be canceled when its lines are reconciled.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t219" class="mis show_mis"><span class="n"><a href="#t219">219</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">state</span> <span class="op">=</span> <span class="str">'open'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t220" class="pln"><span class="n"><a href="#t220">220</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t221" class="run"><span class="n"><a href="#t221">221</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t222" class="pln"><span class="n"><a href="#t222">222</a></span><span class="t">    <span class="key">def</span> <span class="nam">check_confirm_bank</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t223" class="mis show_mis"><span class="n"><a href="#t223">223</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_type</span> <span class="op">==</span> <span class="str">'cash'</span> <span class="key">and</span> <span class="key">not</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">is_zero</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">difference</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t224" class="mis show_mis"><span class="n"><a href="#t224">224</a></span><span class="t">            <span class="nam">action_rec</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'ir.model.data'</span><span class="op">]</span><span class="op">.</span><span class="nam">xmlid_to_object</span><span class="op">(</span><span class="str">'account.action_view_account_bnk_stmt_check'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t225" class="mis show_mis"><span class="n"><a href="#t225">225</a></span><span class="t">            <span class="key">if</span> <span class="nam">action_rec</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t226" class="mis show_mis"><span class="n"><a href="#t226">226</a></span><span class="t">                <span class="nam">action</span> <span class="op">=</span> <span class="nam">action_rec</span><span class="op">.</span><span class="nam">read</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t227" class="mis show_mis"><span class="n"><a href="#t227">227</a></span><span class="t">                <span class="key">return</span> <span class="nam">action</span>&nbsp;</span><span class="r"></span></p>
    <p id="t228" class="mis show_mis"><span class="n"><a href="#t228">228</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">button_confirm_bank</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t229" class="pln"><span class="n"><a href="#t229">229</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t230" class="run"><span class="n"><a href="#t230">230</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t231" class="pln"><span class="n"><a href="#t231">231</a></span><span class="t">    <span class="key">def</span> <span class="nam">button_confirm_bank</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t232" class="mis show_mis"><span class="n"><a href="#t232">232</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">_balance_check</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t233" class="mis show_mis"><span class="n"><a href="#t233">233</a></span><span class="t">        <span class="nam">statements</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">filtered</span><span class="op">(</span><span class="key">lambda</span> <span class="nam">r</span><span class="op">:</span> <span class="nam">r</span><span class="op">.</span><span class="nam">state</span> <span class="op">==</span> <span class="str">'open'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t234" class="mis show_mis"><span class="n"><a href="#t234">234</a></span><span class="t">        <span class="key">for</span> <span class="nam">statement</span> <span class="key">in</span> <span class="nam">statements</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t235" class="mis show_mis"><span class="n"><a href="#t235">235</a></span><span class="t">            <span class="nam">moves</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t236" class="mis show_mis"><span class="n"><a href="#t236">236</a></span><span class="t">            <span class="key">for</span> <span class="nam">st_line</span> <span class="key">in</span> <span class="nam">statement</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t237" class="mis show_mis"><span class="n"><a href="#t237">237</a></span><span class="t">                <span class="key">if</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">account_id</span> <span class="key">and</span> <span class="key">not</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">journal_entry_ids</span><span class="op">.</span><span class="nam">ids</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t238" class="mis show_mis"><span class="n"><a href="#t238">238</a></span><span class="t">                    <span class="nam">st_line</span><span class="op">.</span><span class="nam">fast_counterpart_creation</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t239" class="mis show_mis"><span class="n"><a href="#t239">239</a></span><span class="t">                <span class="key">elif</span> <span class="key">not</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">journal_entry_ids</span><span class="op">.</span><span class="nam">ids</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t240" class="mis show_mis"><span class="n"><a href="#t240">240</a></span><span class="t">                    <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'All the account entries lines must be processed in order to close the statement.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t241" class="mis show_mis"><span class="n"><a href="#t241">241</a></span><span class="t">                <span class="nam">moves</span> <span class="op">=</span> <span class="op">(</span><span class="nam">moves</span> <span class="op">|</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">journal_entry_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t242" class="mis show_mis"><span class="n"><a href="#t242">242</a></span><span class="t">            <span class="key">if</span> <span class="nam">moves</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t243" class="mis show_mis"><span class="n"><a href="#t243">243</a></span><span class="t">                <span class="nam">moves</span><span class="op">.</span><span class="nam">filtered</span><span class="op">(</span><span class="key">lambda</span> <span class="nam">m</span><span class="op">:</span> <span class="nam">m</span><span class="op">.</span><span class="nam">state</span> <span class="op">!=</span> <span class="str">'posted'</span><span class="op">)</span><span class="op">.</span><span class="nam">post</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t244" class="mis show_mis"><span class="n"><a href="#t244">244</a></span><span class="t">            <span class="nam">statement</span><span class="op">.</span><span class="nam">message_post</span><span class="op">(</span><span class="nam">body</span><span class="op">=</span><span class="nam">_</span><span class="op">(</span><span class="str">'Statement %s confirmed, journal items were created.'</span><span class="op">)</span> <span class="op">%</span> <span class="op">(</span><span class="nam">statement</span><span class="op">.</span><span class="nam">name</span><span class="op">,</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t245" class="mis show_mis"><span class="n"><a href="#t245">245</a></span><span class="t">        <span class="nam">statements</span><span class="op">.</span><span class="nam">link_bank_to_partner</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t246" class="mis show_mis"><span class="n"><a href="#t246">246</a></span><span class="t">        <span class="nam">statements</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'state'</span><span class="op">:</span> <span class="str">'confirm'</span><span class="op">,</span> <span class="str">'date_done'</span><span class="op">:</span> <span class="nam">time</span><span class="op">.</span><span class="nam">strftime</span><span class="op">(</span><span class="str">"%Y-%m-%d %H:%M:%S"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t247" class="pln"><span class="n"><a href="#t247">247</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t248" class="run"><span class="n"><a href="#t248">248</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t249" class="pln"><span class="n"><a href="#t249">249</a></span><span class="t">    <span class="key">def</span> <span class="nam">button_journal_entries</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t250" class="mis show_mis"><span class="n"><a href="#t250">250</a></span><span class="t">        <span class="nam">context</span> <span class="op">=</span> <span class="nam">dict</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">_context</span> <span class="key">or</span> <span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t251" class="mis show_mis"><span class="n"><a href="#t251">251</a></span><span class="t">        <span class="nam">context</span><span class="op">[</span><span class="str">'journal_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t252" class="mis show_mis"><span class="n"><a href="#t252">252</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t253" class="pln"><span class="n"><a href="#t253">253</a></span><span class="t">            <span class="str">'name'</span><span class="op">:</span> <span class="nam">_</span><span class="op">(</span><span class="str">'Journal Entries'</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t254" class="pln"><span class="n"><a href="#t254">254</a></span><span class="t">            <span class="str">'view_type'</span><span class="op">:</span> <span class="str">'form'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t255" class="pln"><span class="n"><a href="#t255">255</a></span><span class="t">            <span class="str">'view_mode'</span><span class="op">:</span> <span class="str">'tree,form'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t256" class="pln"><span class="n"><a href="#t256">256</a></span><span class="t">            <span class="str">'res_model'</span><span class="op">:</span> <span class="str">'account.move'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t257" class="pln"><span class="n"><a href="#t257">257</a></span><span class="t">            <span class="str">'view_id'</span><span class="op">:</span> <span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t258" class="pln"><span class="n"><a href="#t258">258</a></span><span class="t">            <span class="str">'type'</span><span class="op">:</span> <span class="str">'ir.actions.act_window'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t259" class="pln"><span class="n"><a href="#t259">259</a></span><span class="t">            <span class="str">'domain'</span><span class="op">:</span> <span class="op">[</span><span class="op">(</span><span class="str">'id'</span><span class="op">,</span> <span class="str">'in'</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">mapped</span><span class="op">(</span><span class="str">'move_line_ids'</span><span class="op">)</span><span class="op">.</span><span class="nam">mapped</span><span class="op">(</span><span class="str">'move_id'</span><span class="op">)</span><span class="op">.</span><span class="nam">ids</span><span class="op">)</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t260" class="pln"><span class="n"><a href="#t260">260</a></span><span class="t">            <span class="str">'context'</span><span class="op">:</span> <span class="nam">context</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t261" class="pln"><span class="n"><a href="#t261">261</a></span><span class="t">        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t262" class="pln"><span class="n"><a href="#t262">262</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t263" class="run"><span class="n"><a href="#t263">263</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t264" class="pln"><span class="n"><a href="#t264">264</a></span><span class="t">    <span class="key">def</span> <span class="nam">button_open</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t265" class="pln"><span class="n"><a href="#t265">265</a></span><span class="t">        <span class="str">""" Changes statement state to Running."""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t266" class="mis show_mis"><span class="n"><a href="#t266">266</a></span><span class="t">        <span class="key">for</span> <span class="nam">statement</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t267" class="mis show_mis"><span class="n"><a href="#t267">267</a></span><span class="t">            <span class="key">if</span> <span class="key">not</span> <span class="nam">statement</span><span class="op">.</span><span class="nam">name</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t268" class="mis show_mis"><span class="n"><a href="#t268">268</a></span><span class="t">                <span class="nam">context</span> <span class="op">=</span> <span class="op">{</span><span class="str">'ir_sequence_date'</span><span class="op">:</span> <span class="nam">statement</span><span class="op">.</span><span class="nam">date</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t269" class="mis show_mis"><span class="n"><a href="#t269">269</a></span><span class="t">                <span class="key">if</span> <span class="nam">statement</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">sequence_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t270" class="mis show_mis"><span class="n"><a href="#t270">270</a></span><span class="t">                    <span class="nam">st_number</span> <span class="op">=</span> <span class="nam">statement</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">sequence_id</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="op">**</span><span class="nam">context</span><span class="op">)</span><span class="op">.</span><span class="nam">next_by_id</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t271" class="pln"><span class="n"><a href="#t271">271</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t272" class="mis show_mis"><span class="n"><a href="#t272">272</a></span><span class="t">                    <span class="nam">SequenceObj</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'ir.sequence'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t273" class="mis show_mis"><span class="n"><a href="#t273">273</a></span><span class="t">                    <span class="nam">st_number</span> <span class="op">=</span> <span class="nam">SequenceObj</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="op">**</span><span class="nam">context</span><span class="op">)</span><span class="op">.</span><span class="nam">next_by_code</span><span class="op">(</span><span class="str">'account.bank.statement'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t274" class="mis show_mis"><span class="n"><a href="#t274">274</a></span><span class="t">                <span class="nam">statement</span><span class="op">.</span><span class="nam">name</span> <span class="op">=</span> <span class="nam">st_number</span>&nbsp;</span><span class="r"></span></p>
    <p id="t275" class="mis show_mis"><span class="n"><a href="#t275">275</a></span><span class="t">            <span class="nam">statement</span><span class="op">.</span><span class="nam">state</span> <span class="op">=</span> <span class="str">'open'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t276" class="pln"><span class="n"><a href="#t276">276</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t277" class="run"><span class="n"><a href="#t277">277</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t278" class="pln"><span class="n"><a href="#t278">278</a></span><span class="t">    <span class="key">def</span> <span class="nam">reconciliation_widget_preprocess</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t279" class="pln"><span class="n"><a href="#t279">279</a></span><span class="t">        <span class="str">""" Get statement lines of the specified statements or all unreconciled statement lines and try to automatically reconcile them / find them a partner.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t280" class="pln"><span class="n"><a href="#t280">280</a></span><span class="t"><span class="str">            Return ids of statement lines left to reconcile and other data for the reconciliation widget.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t281" class="pln"><span class="n"><a href="#t281">281</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t282" class="mis show_mis"><span class="n"><a href="#t282">282</a></span><span class="t">        <span class="nam">statements</span> <span class="op">=</span> <span class="nam">self</span>&nbsp;</span><span class="r"></span></p>
    <p id="t283" class="mis show_mis"><span class="n"><a href="#t283">283</a></span><span class="t">        <span class="nam">bsl_obj</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.bank.statement.line'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t284" class="pln"><span class="n"><a href="#t284">284</a></span><span class="t">        <span class="com"># NB : The field account_id can be used at the statement line creation/import to avoid the reconciliation process on it later on,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t285" class="pln"><span class="n"><a href="#t285">285</a></span><span class="t">        <span class="com"># this is why we filter out statements lines where account_id is set</span>&nbsp;</span><span class="r"></span></p>
    <p id="t286" class="pln"><span class="n"><a href="#t286">286</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t287" class="mis show_mis"><span class="n"><a href="#t287">287</a></span><span class="t">        <span class="nam">sql_query</span> <span class="op">=</span> <span class="str">"""SELECT stl.id </span>&nbsp;</span><span class="r"></span></p>
    <p id="t288" class="pln"><span class="n"><a href="#t288">288</a></span><span class="t"><span class="str">                        FROM account_bank_statement_line stl  </span>&nbsp;</span><span class="r"></span></p>
    <p id="t289" class="pln"><span class="n"><a href="#t289">289</a></span><span class="t"><span class="str">                        WHERE account_id IS NULL AND not exists (select 1 from account_move m where m.statement_line_id = stl.id)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t290" class="pln"><span class="n"><a href="#t290">290</a></span><span class="t"><span class="str">                            AND company_id = %s</span>&nbsp;</span><span class="r"></span></p>
    <p id="t291" class="pln"><span class="n"><a href="#t291">291</a></span><span class="t"><span class="str">                """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t292" class="mis show_mis"><span class="n"><a href="#t292">292</a></span><span class="t">        <span class="nam">params</span> <span class="op">=</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">user</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t293" class="mis show_mis"><span class="n"><a href="#t293">293</a></span><span class="t">        <span class="key">if</span> <span class="nam">statements</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t294" class="mis show_mis"><span class="n"><a href="#t294">294</a></span><span class="t">            <span class="nam">sql_query</span> <span class="op">+=</span> <span class="str">' AND stl.statement_id IN %s'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t295" class="mis show_mis"><span class="n"><a href="#t295">295</a></span><span class="t">            <span class="nam">params</span> <span class="op">+=</span> <span class="op">(</span><span class="nam">tuple</span><span class="op">(</span><span class="nam">statements</span><span class="op">.</span><span class="nam">ids</span><span class="op">)</span><span class="op">,</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t296" class="mis show_mis"><span class="n"><a href="#t296">296</a></span><span class="t">        <span class="nam">sql_query</span> <span class="op">+=</span> <span class="str">' ORDER BY stl.id'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t297" class="mis show_mis"><span class="n"><a href="#t297">297</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">cr</span><span class="op">.</span><span class="nam">execute</span><span class="op">(</span><span class="nam">sql_query</span><span class="op">,</span> <span class="nam">params</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t298" class="mis show_mis"><span class="n"><a href="#t298">298</a></span><span class="t">        <span class="nam">st_lines_left</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.bank.statement.line'</span><span class="op">]</span><span class="op">.</span><span class="nam">browse</span><span class="op">(</span><span class="op">[</span><span class="nam">line</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'id'</span><span class="op">)</span> <span class="key">for</span> <span class="nam">line</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">cr</span><span class="op">.</span><span class="nam">dictfetchall</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t299" class="pln"><span class="n"><a href="#t299">299</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t300" class="pln"><span class="n"><a href="#t300">300</a></span><span class="t">        <span class="com">#try to assign partner to bank_statement_line</span>&nbsp;</span><span class="r"></span></p>
    <p id="t301" class="mis show_mis"><span class="n"><a href="#t301">301</a></span><span class="t">        <span class="nam">stl_to_assign_partner</span> <span class="op">=</span> <span class="op">[</span><span class="nam">stl</span><span class="op">.</span><span class="nam">id</span> <span class="key">for</span> <span class="nam">stl</span> <span class="key">in</span> <span class="nam">st_lines_left</span> <span class="key">if</span> <span class="key">not</span> <span class="nam">stl</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t302" class="mis show_mis"><span class="n"><a href="#t302">302</a></span><span class="t">        <span class="nam">refs</span> <span class="op">=</span> <span class="nam">list</span><span class="op">(</span><span class="nam">set</span><span class="op">(</span><span class="op">[</span><span class="nam">st</span><span class="op">.</span><span class="nam">name</span> <span class="key">for</span> <span class="nam">st</span> <span class="key">in</span> <span class="nam">st_lines_left</span> <span class="key">if</span> <span class="key">not</span> <span class="nam">stl</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t303" class="mis show_mis"><span class="n"><a href="#t303">303</a></span><span class="t">        <span class="key">if</span> <span class="nam">st_lines_left</span> <span class="key">and</span> <span class="nam">stl_to_assign_partner</span> <span class="key">and</span> <span class="nam">refs</span><span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t304" class="pln"><span class="n"><a href="#t304">304</a></span><span class="t">           <span class="key">and</span> <span class="nam">st_lines_left</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_credit_account_id</span><span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t305" class="pln"><span class="n"><a href="#t305">305</a></span><span class="t">           <span class="key">and</span> <span class="nam">st_lines_left</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_debit_account_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t306" class="pln"><span class="n"><a href="#t306">306</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t307" class="mis show_mis"><span class="n"><a href="#t307">307</a></span><span class="t">            <span class="nam">sql_query</span> <span class="op">=</span> <span class="str">"""SELECT aml.partner_id, aml.ref, stl.id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t308" class="pln"><span class="n"><a href="#t308">308</a></span><span class="t"><span class="str">                            FROM account_move_line aml</span>&nbsp;</span><span class="r"></span></p>
    <p id="t309" class="pln"><span class="n"><a href="#t309">309</a></span><span class="t"><span class="str">                                JOIN account_account acc ON acc.id = aml.account_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t310" class="pln"><span class="n"><a href="#t310">310</a></span><span class="t"><span class="str">                                JOIN account_bank_statement_line stl ON aml.ref = stl.name</span>&nbsp;</span><span class="r"></span></p>
    <p id="t311" class="pln"><span class="n"><a href="#t311">311</a></span><span class="t"><span class="str">                            WHERE (aml.company_id = %s </span>&nbsp;</span><span class="r"></span></p>
    <p id="t312" class="pln"><span class="n"><a href="#t312">312</a></span><span class="t"><span class="str">                                AND aml.partner_id IS NOT NULL) </span>&nbsp;</span><span class="r"></span></p>
    <p id="t313" class="pln"><span class="n"><a href="#t313">313</a></span><span class="t"><span class="str">                                AND (</span>&nbsp;</span><span class="r"></span></p>
    <p id="t314" class="pln"><span class="n"><a href="#t314">314</a></span><span class="t"><span class="str">                                    (aml.statement_id IS NULL AND aml.account_id IN %s) </span>&nbsp;</span><span class="r"></span></p>
    <p id="t315" class="pln"><span class="n"><a href="#t315">315</a></span><span class="t"><span class="str">                                    OR </span>&nbsp;</span><span class="r"></span></p>
    <p id="t316" class="pln"><span class="n"><a href="#t316">316</a></span><span class="t"><span class="str">                                    (acc.internal_type IN ('payable', 'receivable') AND aml.reconciled = false)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t317" class="pln"><span class="n"><a href="#t317">317</a></span><span class="t"><span class="str">                                    )</span>&nbsp;</span><span class="r"></span></p>
    <p id="t318" class="pln"><span class="n"><a href="#t318">318</a></span><span class="t"><span class="str">                                AND aml.ref IN %s</span>&nbsp;</span><span class="r"></span></p>
    <p id="t319" class="pln"><span class="n"><a href="#t319">319</a></span><span class="t"><span class="str">                                """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t320" class="mis show_mis"><span class="n"><a href="#t320">320</a></span><span class="t">            <span class="nam">params</span> <span class="op">=</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">user</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="op">(</span><span class="nam">st_lines_left</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_credit_account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">st_lines_left</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_debit_account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span><span class="op">,</span> <span class="nam">tuple</span><span class="op">(</span><span class="nam">refs</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t321" class="mis show_mis"><span class="n"><a href="#t321">321</a></span><span class="t">            <span class="key">if</span> <span class="nam">statements</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t322" class="mis show_mis"><span class="n"><a href="#t322">322</a></span><span class="t">                <span class="nam">sql_query</span> <span class="op">+=</span> <span class="str">'AND stl.id IN %s'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t323" class="mis show_mis"><span class="n"><a href="#t323">323</a></span><span class="t">                <span class="nam">params</span> <span class="op">+=</span> <span class="op">(</span><span class="nam">tuple</span><span class="op">(</span><span class="nam">stl_to_assign_partner</span><span class="op">)</span><span class="op">,</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t324" class="mis show_mis"><span class="n"><a href="#t324">324</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">cr</span><span class="op">.</span><span class="nam">execute</span><span class="op">(</span><span class="nam">sql_query</span><span class="op">,</span> <span class="nam">params</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t325" class="mis show_mis"><span class="n"><a href="#t325">325</a></span><span class="t">            <span class="nam">results</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">cr</span><span class="op">.</span><span class="nam">dictfetchall</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t326" class="mis show_mis"><span class="n"><a href="#t326">326</a></span><span class="t">            <span class="nam">st_line</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.bank.statement.line'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t327" class="mis show_mis"><span class="n"><a href="#t327">327</a></span><span class="t">            <span class="key">for</span> <span class="nam">line</span> <span class="key">in</span> <span class="nam">results</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t328" class="mis show_mis"><span class="n"><a href="#t328">328</a></span><span class="t">                <span class="nam">st_line</span><span class="op">.</span><span class="nam">browse</span><span class="op">(</span><span class="nam">line</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'id'</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'partner_id'</span><span class="op">:</span> <span class="nam">line</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'partner_id'</span><span class="op">)</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t329" class="pln"><span class="n"><a href="#t329">329</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t330" class="mis show_mis"><span class="n"><a href="#t330">330</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t331" class="pln"><span class="n"><a href="#t331">331</a></span><span class="t">            <span class="str">'st_lines_ids'</span><span class="op">:</span> <span class="nam">st_lines_left</span><span class="op">.</span><span class="nam">ids</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t332" class="pln"><span class="n"><a href="#t332">332</a></span><span class="t">            <span class="str">'notifications'</span><span class="op">:</span> <span class="op">[</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t333" class="pln"><span class="n"><a href="#t333">333</a></span><span class="t">            <span class="str">'statement_name'</span><span class="op">:</span> <span class="nam">len</span><span class="op">(</span><span class="nam">statements</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span> <span class="key">and</span> <span class="nam">statements</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">name</span> <span class="key">or</span> <span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t334" class="pln"><span class="n"><a href="#t334">334</a></span><span class="t">            <span class="str">'num_already_reconciled_lines'</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t335" class="pln"><span class="n"><a href="#t335">335</a></span><span class="t">        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t336" class="pln"><span class="n"><a href="#t336">336</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t337" class="run"><span class="n"><a href="#t337">337</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t338" class="pln"><span class="n"><a href="#t338">338</a></span><span class="t">    <span class="key">def</span> <span class="nam">link_bank_to_partner</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t339" class="mis show_mis"><span class="n"><a href="#t339">339</a></span><span class="t">        <span class="key">for</span> <span class="nam">statement</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t340" class="mis show_mis"><span class="n"><a href="#t340">340</a></span><span class="t">            <span class="key">for</span> <span class="nam">st_line</span> <span class="key">in</span> <span class="nam">statement</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t341" class="mis show_mis"><span class="n"><a href="#t341">341</a></span><span class="t">                <span class="key">if</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">bank_account_id</span> <span class="key">and</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">partner_id</span> <span class="key">and</span> <span class="key">not</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">bank_account_id</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t342" class="mis show_mis"><span class="n"><a href="#t342">342</a></span><span class="t">                    <span class="nam">st_line</span><span class="op">.</span><span class="nam">bank_account_id</span><span class="op">.</span><span class="nam">partner_id</span> <span class="op">=</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">partner_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t343" class="pln"><span class="n"><a href="#t343">343</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t344" class="pln"><span class="n"><a href="#t344">344</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t345" class="run"><span class="n"><a href="#t345">345</a></span><span class="t"><span class="key">class</span> <span class="nam">AccountBankStatementLine</span><span class="op">(</span><span class="nam">models</span><span class="op">.</span><span class="nam">Model</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t346" class="run"><span class="n"><a href="#t346">346</a></span><span class="t">    <span class="nam">_name</span> <span class="op">=</span> <span class="str">"account.bank.statement.line"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t347" class="run"><span class="n"><a href="#t347">347</a></span><span class="t">    <span class="nam">_description</span> <span class="op">=</span> <span class="str">"Bank Statement Line"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t348" class="run"><span class="n"><a href="#t348">348</a></span><span class="t">    <span class="nam">_order</span> <span class="op">=</span> <span class="str">"statement_id desc, sequence, id desc"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t349" class="run"><span class="n"><a href="#t349">349</a></span><span class="t">    <span class="nam">_inherit</span> <span class="op">=</span> <span class="op">[</span><span class="str">'ir.needaction_mixin'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t350" class="pln"><span class="n"><a href="#t350">350</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t351" class="run"><span class="n"><a href="#t351">351</a></span><span class="t">    <span class="nam">name</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Label'</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t352" class="run"><span class="n"><a href="#t352">352</a></span><span class="t">    <span class="nam">date</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Date</span><span class="op">(</span><span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="key">lambda</span> <span class="nam">self</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_context</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'date'</span><span class="op">,</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Date</span><span class="op">.</span><span class="nam">context_today</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t353" class="run"><span class="n"><a href="#t353">353</a></span><span class="t">    <span class="nam">amount</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Monetary</span><span class="op">(</span><span class="nam">digits</span><span class="op">=</span><span class="num">0</span><span class="op">,</span> <span class="nam">currency_field</span><span class="op">=</span><span class="str">'journal_currency_id'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t354" class="run"><span class="n"><a href="#t354">354</a></span><span class="t">    <span class="nam">journal_currency_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'res.currency'</span><span class="op">,</span> <span class="nam">related</span><span class="op">=</span><span class="str">'statement_id.currency_id'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t355" class="pln"><span class="n"><a href="#t355">355</a></span><span class="t">        <span class="nam">help</span><span class="op">=</span><span class="str">'Utility field to express amount currency'</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t356" class="run"><span class="n"><a href="#t356">356</a></span><span class="t">    <span class="nam">partner_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'res.partner'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Partner'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t357" class="run"><span class="n"><a href="#t357">357</a></span><span class="t">    <span class="nam">bank_account_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'res.partner.bank'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Bank Account'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t358" class="run"><span class="n"><a href="#t358">358</a></span><span class="t">    <span class="nam">account_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.account'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Counterpart Account'</span><span class="op">,</span> <span class="nam">domain</span><span class="op">=</span><span class="op">[</span><span class="op">(</span><span class="str">'deprecated'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t359" class="pln"><span class="n"><a href="#t359">359</a></span><span class="t">        <span class="nam">help</span><span class="op">=</span><span class="str">"This technical field can be used at the statement line creation/import time in order to avoid the reconciliation"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t360" class="pln"><span class="n"><a href="#t360">360</a></span><span class="t">             <span class="str">" process on it later on. The statement line will simply create a counterpart on this account"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t361" class="run"><span class="n"><a href="#t361">361</a></span><span class="t">    <span class="nam">statement_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.bank.statement'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Statement'</span><span class="op">,</span> <span class="nam">index</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">required</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">ondelete</span><span class="op">=</span><span class="str">'cascade'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t362" class="run"><span class="n"><a href="#t362">362</a></span><span class="t">    <span class="nam">journal_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'account.journal'</span><span class="op">,</span> <span class="nam">related</span><span class="op">=</span><span class="str">'statement_id.journal_id'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Journal'</span><span class="op">,</span> <span class="nam">store</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t363" class="run"><span class="n"><a href="#t363">363</a></span><span class="t">    <span class="nam">partner_name</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">help</span><span class="op">=</span><span class="str">"This field is used to record the third party name when importing bank statement in electronic format,"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t364" class="pln"><span class="n"><a href="#t364">364</a></span><span class="t">             <span class="str">" when the partner doesn't exist yet in the database (or cannot be found)."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t365" class="run"><span class="n"><a href="#t365">365</a></span><span class="t">    <span class="nam">ref</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Reference'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t366" class="run"><span class="n"><a href="#t366">366</a></span><span class="t">    <span class="nam">note</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Text</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Notes'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t367" class="run"><span class="n"><a href="#t367">367</a></span><span class="t">    <span class="nam">sequence</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Integer</span><span class="op">(</span><span class="nam">index</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">"Gives the sequence order when displaying a list of bank statement lines."</span><span class="op">,</span> <span class="nam">default</span><span class="op">=</span><span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t368" class="run"><span class="n"><a href="#t368">368</a></span><span class="t">    <span class="nam">company_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'res.company'</span><span class="op">,</span> <span class="nam">related</span><span class="op">=</span><span class="str">'statement_id.company_id'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Company'</span><span class="op">,</span> <span class="nam">store</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t369" class="run"><span class="n"><a href="#t369">369</a></span><span class="t">    <span class="nam">journal_entry_ids</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">One2many</span><span class="op">(</span><span class="str">'account.move'</span><span class="op">,</span> <span class="str">'statement_line_id'</span><span class="op">,</span> <span class="str">'Journal Entries'</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t370" class="run"><span class="n"><a href="#t370">370</a></span><span class="t">    <span class="nam">amount_currency</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Monetary</span><span class="op">(</span><span class="nam">help</span><span class="op">=</span><span class="str">"The amount expressed in an optional other currency if it is a multi-currency entry."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t371" class="run"><span class="n"><a href="#t371">371</a></span><span class="t">    <span class="nam">currency_id</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Many2one</span><span class="op">(</span><span class="str">'res.currency'</span><span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Currency'</span><span class="op">,</span> <span class="nam">help</span><span class="op">=</span><span class="str">"The optional other currency if it is a multi-currency entry."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t372" class="run"><span class="n"><a href="#t372">372</a></span><span class="t">    <span class="nam">state</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Selection</span><span class="op">(</span><span class="nam">related</span><span class="op">=</span><span class="str">'statement_id.state'</span> <span class="op">,</span> <span class="nam">string</span><span class="op">=</span><span class="str">'Status'</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t373" class="run"><span class="n"><a href="#t373">373</a></span><span class="t">    <span class="nam">move_name</span> <span class="op">=</span> <span class="nam">fields</span><span class="op">.</span><span class="nam">Char</span><span class="op">(</span><span class="nam">string</span><span class="op">=</span><span class="str">'Journal Entry Name'</span><span class="op">,</span> <span class="nam">readonly</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t374" class="pln"><span class="n"><a href="#t374">374</a></span><span class="t">        <span class="nam">default</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">copy</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t375" class="pln"><span class="n"><a href="#t375">375</a></span><span class="t">        <span class="nam">help</span><span class="op">=</span><span class="str">"Technical field holding the number given to the journal entry, automatically set when the statement line is reconciled then stored to set the same number again if the line is cancelled, set to draft and re-processed again."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t376" class="pln"><span class="n"><a href="#t376">376</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t377" class="run"><span class="n"><a href="#t377">377</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">one</span>&nbsp;</span><span class="r"></span></p>
    <p id="t378" class="run"><span class="n"><a href="#t378">378</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">constrains</span><span class="op">(</span><span class="str">'amount'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t379" class="pln"><span class="n"><a href="#t379">379</a></span><span class="t">    <span class="key">def</span> <span class="nam">_check_amount</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t380" class="pln"><span class="n"><a href="#t380">380</a></span><span class="t">        <span class="com"># This constraint could possibly underline flaws in bank statement import (eg. inability to</span>&nbsp;</span><span class="r"></span></p>
    <p id="t381" class="pln"><span class="n"><a href="#t381">381</a></span><span class="t">        <span class="com"># support hacks such as using dummy transactions to give additional informations)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t382" class="mis show_mis"><span class="n"><a href="#t382">382</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t383" class="mis show_mis"><span class="n"><a href="#t383">383</a></span><span class="t">            <span class="key">raise</span> <span class="nam">ValidationError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'A transaction can\'t have a 0 amount.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t384" class="pln"><span class="n"><a href="#t384">384</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t385" class="run"><span class="n"><a href="#t385">385</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">one</span>&nbsp;</span><span class="r"></span></p>
    <p id="t386" class="run"><span class="n"><a href="#t386">386</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">constrains</span><span class="op">(</span><span class="str">'amount'</span><span class="op">,</span> <span class="str">'amount_currency'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t387" class="pln"><span class="n"><a href="#t387">387</a></span><span class="t">    <span class="key">def</span> <span class="nam">_check_amount_currency</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t388" class="mis show_mis"><span class="n"><a href="#t388">388</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount_currency</span> <span class="op">!=</span> <span class="num">0</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t389" class="mis show_mis"><span class="n"><a href="#t389">389</a></span><span class="t">            <span class="key">raise</span> <span class="nam">ValidationError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'If "Amount Currency" is specified, then "Amount" must be as well.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t390" class="pln"><span class="n"><a href="#t390">390</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t391" class="run"><span class="n"><a href="#t391">391</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">model</span>&nbsp;</span><span class="r"></span></p>
    <p id="t392" class="pln"><span class="n"><a href="#t392">392</a></span><span class="t">    <span class="key">def</span> <span class="nam">create</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">vals</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t393" class="mis show_mis"><span class="n"><a href="#t393">393</a></span><span class="t">        <span class="nam">line</span> <span class="op">=</span> <span class="nam">super</span><span class="op">(</span><span class="nam">AccountBankStatementLine</span><span class="op">,</span> <span class="nam">self</span><span class="op">)</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="nam">vals</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t394" class="pln"><span class="n"><a href="#t394">394</a></span><span class="t">        <span class="com"># The most awesome fix you will ever see is below.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t395" class="pln"><span class="n"><a href="#t395">395</a></span><span class="t">        <span class="com"># Explanation: during a 'create', the 'convert_to_cache' method is not called. Moreover, at</span>&nbsp;</span><span class="r"></span></p>
    <p id="t396" class="pln"><span class="n"><a href="#t396">396</a></span><span class="t">        <span class="com"># that point 'journal_currency_id' is not yet known since it is a related field. It means</span>&nbsp;</span><span class="r"></span></p>
    <p id="t397" class="pln"><span class="n"><a href="#t397">397</a></span><span class="t">        <span class="com"># that the 'amount' field will not be properly rounded. The line below triggers a write on</span>&nbsp;</span><span class="r"></span></p>
    <p id="t398" class="pln"><span class="n"><a href="#t398">398</a></span><span class="t">        <span class="com"># the 'amount' field, which will trigger the 'convert_to_cache' method, and ultimately round</span>&nbsp;</span><span class="r"></span></p>
    <p id="t399" class="pln"><span class="n"><a href="#t399">399</a></span><span class="t">        <span class="com"># the field correctly.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t400" class="pln"><span class="n"><a href="#t400">400</a></span><span class="t">        <span class="com"># This is obviously an awful workaround, but at the time of writing, the ORM does not</span>&nbsp;</span><span class="r"></span></p>
    <p id="t401" class="pln"><span class="n"><a href="#t401">401</a></span><span class="t">        <span class="com"># provide a clean mechanism to fix the issue.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t402" class="mis show_mis"><span class="n"><a href="#t402">402</a></span><span class="t">        <span class="nam">line</span><span class="op">.</span><span class="nam">amount</span> <span class="op">=</span> <span class="nam">line</span><span class="op">.</span><span class="nam">amount</span>&nbsp;</span><span class="r"></span></p>
    <p id="t403" class="mis show_mis"><span class="n"><a href="#t403">403</a></span><span class="t">        <span class="key">return</span> <span class="nam">line</span>&nbsp;</span><span class="r"></span></p>
    <p id="t404" class="pln"><span class="n"><a href="#t404">404</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t405" class="run"><span class="n"><a href="#t405">405</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t406" class="pln"><span class="n"><a href="#t406">406</a></span><span class="t">    <span class="key">def</span> <span class="nam">unlink</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t407" class="mis show_mis"><span class="n"><a href="#t407">407</a></span><span class="t">        <span class="key">for</span> <span class="nam">line</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t408" class="mis show_mis"><span class="n"><a href="#t408">408</a></span><span class="t">            <span class="key">if</span> <span class="nam">line</span><span class="op">.</span><span class="nam">journal_entry_ids</span><span class="op">.</span><span class="nam">ids</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t409" class="mis show_mis"><span class="n"><a href="#t409">409</a></span><span class="t">                <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'In order to delete a bank statement line, you must first cancel it to delete related journal items.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t410" class="mis show_mis"><span class="n"><a href="#t410">410</a></span><span class="t">        <span class="key">return</span> <span class="nam">super</span><span class="op">(</span><span class="nam">AccountBankStatementLine</span><span class="op">,</span> <span class="nam">self</span><span class="op">)</span><span class="op">.</span><span class="nam">unlink</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t411" class="pln"><span class="n"><a href="#t411">411</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t412" class="run"><span class="n"><a href="#t412">412</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">model</span>&nbsp;</span><span class="r"></span></p>
    <p id="t413" class="pln"><span class="n"><a href="#t413">413</a></span><span class="t">    <span class="key">def</span> <span class="nam">_needaction_domain_get</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t414" class="mis show_mis"><span class="n"><a href="#t414">414</a></span><span class="t">        <span class="key">return</span> <span class="op">[</span><span class="op">(</span><span class="str">'journal_entry_ids'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'account_id'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t415" class="pln"><span class="n"><a href="#t415">415</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t416" class="run"><span class="n"><a href="#t416">416</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t417" class="pln"><span class="n"><a href="#t417">417</a></span><span class="t">    <span class="key">def</span> <span class="nam">button_cancel_reconciliation</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t418" class="mis show_mis"><span class="n"><a href="#t418">418</a></span><span class="t">        <span class="nam">moves_to_cancel</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t419" class="mis show_mis"><span class="n"><a href="#t419">419</a></span><span class="t">        <span class="nam">payment_to_unreconcile</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.payment'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t420" class="mis show_mis"><span class="n"><a href="#t420">420</a></span><span class="t">        <span class="nam">payment_to_cancel</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.payment'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t421" class="mis show_mis"><span class="n"><a href="#t421">421</a></span><span class="t">        <span class="key">for</span> <span class="nam">st_line</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t422" class="mis show_mis"><span class="n"><a href="#t422">422</a></span><span class="t">            <span class="nam">moves_to_unbind</span> <span class="op">=</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">journal_entry_ids</span>&nbsp;</span><span class="r"></span></p>
    <p id="t423" class="mis show_mis"><span class="n"><a href="#t423">423</a></span><span class="t">            <span class="key">for</span> <span class="nam">move</span> <span class="key">in</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">journal_entry_ids</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t424" class="mis show_mis"><span class="n"><a href="#t424">424</a></span><span class="t">                <span class="key">for</span> <span class="nam">line</span> <span class="key">in</span> <span class="nam">move</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t425" class="mis show_mis"><span class="n"><a href="#t425">425</a></span><span class="t">                    <span class="nam">payment_to_unreconcile</span> <span class="op">|=</span> <span class="nam">line</span><span class="op">.</span><span class="nam">payment_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t426" class="mis show_mis"><span class="n"><a href="#t426">426</a></span><span class="t">                    <span class="key">if</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">move_name</span> <span class="key">and</span> <span class="nam">line</span><span class="op">.</span><span class="nam">payment_id</span><span class="op">.</span><span class="nam">payment_reference</span> <span class="op">==</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">move_name</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t427" class="pln"><span class="n"><a href="#t427">427</a></span><span class="t">                        <span class="com">#there can be several moves linked to a statement line but maximum one created by the line itself</span>&nbsp;</span><span class="r"></span></p>
    <p id="t428" class="mis show_mis"><span class="n"><a href="#t428">428</a></span><span class="t">                        <span class="nam">moves_to_cancel</span> <span class="op">|=</span> <span class="nam">move</span>&nbsp;</span><span class="r"></span></p>
    <p id="t429" class="mis show_mis"><span class="n"><a href="#t429">429</a></span><span class="t">                        <span class="nam">payment_to_cancel</span> <span class="op">|=</span> <span class="nam">line</span><span class="op">.</span><span class="nam">payment_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t430" class="pln"><span class="n"><a href="#t430">430</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t431" class="mis show_mis"><span class="n"><a href="#t431">431</a></span><span class="t">            <span class="nam">moves_to_unbind</span> <span class="op">=</span> <span class="nam">moves_to_unbind</span> <span class="op">-</span> <span class="nam">moves_to_cancel</span>&nbsp;</span><span class="r"></span></p>
    <p id="t432" class="pln"><span class="n"><a href="#t432">432</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t433" class="mis show_mis"><span class="n"><a href="#t433">433</a></span><span class="t">            <span class="key">if</span> <span class="nam">moves_to_unbind</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t434" class="mis show_mis"><span class="n"><a href="#t434">434</a></span><span class="t">                <span class="nam">moves_to_unbind</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'statement_line_id'</span><span class="op">:</span> <span class="nam">False</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t435" class="mis show_mis"><span class="n"><a href="#t435">435</a></span><span class="t">                <span class="key">for</span> <span class="nam">move</span> <span class="key">in</span> <span class="nam">moves_to_unbind</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t436" class="mis show_mis"><span class="n"><a href="#t436">436</a></span><span class="t">                    <span class="nam">move</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">.</span><span class="nam">filtered</span><span class="op">(</span><span class="key">lambda</span> <span class="nam">x</span><span class="op">:</span> <span class="nam">x</span><span class="op">.</span><span class="nam">statement_id</span> <span class="op">==</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">statement_id</span><span class="op">)</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'statement_id'</span><span class="op">:</span> <span class="nam">False</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t437" class="pln"><span class="n"><a href="#t437">437</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t438" class="mis show_mis"><span class="n"><a href="#t438">438</a></span><span class="t">        <span class="nam">payment_to_unreconcile</span> <span class="op">=</span> <span class="nam">payment_to_unreconcile</span> <span class="op">-</span> <span class="nam">payment_to_cancel</span>&nbsp;</span><span class="r"></span></p>
    <p id="t439" class="mis show_mis"><span class="n"><a href="#t439">439</a></span><span class="t">        <span class="key">if</span> <span class="nam">payment_to_unreconcile</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t440" class="mis show_mis"><span class="n"><a href="#t440">440</a></span><span class="t">            <span class="nam">payment_to_unreconcile</span><span class="op">.</span><span class="nam">unreconcile</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t441" class="pln"><span class="n"><a href="#t441">441</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t442" class="mis show_mis"><span class="n"><a href="#t442">442</a></span><span class="t">        <span class="key">if</span> <span class="nam">moves_to_cancel</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t443" class="mis show_mis"><span class="n"><a href="#t443">443</a></span><span class="t">            <span class="key">for</span> <span class="nam">move</span> <span class="key">in</span> <span class="nam">moves_to_cancel</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t444" class="mis show_mis"><span class="n"><a href="#t444">444</a></span><span class="t">                <span class="nam">move</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">.</span><span class="nam">remove_move_reconcile</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t445" class="mis show_mis"><span class="n"><a href="#t445">445</a></span><span class="t">            <span class="nam">moves_to_cancel</span><span class="op">.</span><span class="nam">button_cancel</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t446" class="mis show_mis"><span class="n"><a href="#t446">446</a></span><span class="t">            <span class="nam">moves_to_cancel</span><span class="op">.</span><span class="nam">unlink</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t447" class="mis show_mis"><span class="n"><a href="#t447">447</a></span><span class="t">        <span class="key">if</span> <span class="nam">payment_to_cancel</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t448" class="mis show_mis"><span class="n"><a href="#t448">448</a></span><span class="t">            <span class="nam">payment_to_cancel</span><span class="op">.</span><span class="nam">unlink</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t449" class="pln"><span class="n"><a href="#t449">449</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t450" class="pln"><span class="n"><a href="#t450">450</a></span><span class="t">    <span class="com">####################################################</span>&nbsp;</span><span class="r"></span></p>
    <p id="t451" class="pln"><span class="n"><a href="#t451">451</a></span><span class="t">    <span class="com"># Reconciliation interface methods</span>&nbsp;</span><span class="r"></span></p>
    <p id="t452" class="pln"><span class="n"><a href="#t452">452</a></span><span class="t">    <span class="com">####################################################</span>&nbsp;</span><span class="r"></span></p>
    <p id="t453" class="run"><span class="n"><a href="#t453">453</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t454" class="pln"><span class="n"><a href="#t454">454</a></span><span class="t">    <span class="key">def</span> <span class="nam">reconciliation_widget_auto_reconcile</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">num_already_reconciled_lines</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t455" class="mis show_mis"><span class="n"><a href="#t455">455</a></span><span class="t">        <span class="nam">automatic_reconciliation_entries</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.bank.statement.line'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t456" class="mis show_mis"><span class="n"><a href="#t456">456</a></span><span class="t">        <span class="nam">unreconciled</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.bank.statement.line'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t457" class="mis show_mis"><span class="n"><a href="#t457">457</a></span><span class="t">        <span class="key">for</span> <span class="nam">stl</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t458" class="mis show_mis"><span class="n"><a href="#t458">458</a></span><span class="t">            <span class="nam">res</span> <span class="op">=</span> <span class="nam">stl</span><span class="op">.</span><span class="nam">auto_reconcile</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t459" class="mis show_mis"><span class="n"><a href="#t459">459</a></span><span class="t">            <span class="key">if</span> <span class="nam">res</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t460" class="mis show_mis"><span class="n"><a href="#t460">460</a></span><span class="t">                <span class="nam">automatic_reconciliation_entries</span> <span class="op">+=</span> <span class="nam">stl</span>&nbsp;</span><span class="r"></span></p>
    <p id="t461" class="pln"><span class="n"><a href="#t461">461</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t462" class="mis show_mis"><span class="n"><a href="#t462">462</a></span><span class="t">                <span class="nam">unreconciled</span> <span class="op">+=</span> <span class="nam">stl</span>&nbsp;</span><span class="r"></span></p>
    <p id="t463" class="pln"><span class="n"><a href="#t463">463</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t464" class="pln"><span class="n"><a href="#t464">464</a></span><span class="t">        <span class="com"># Collect various informations for the reconciliation widget</span>&nbsp;</span><span class="r"></span></p>
    <p id="t465" class="mis show_mis"><span class="n"><a href="#t465">465</a></span><span class="t">        <span class="nam">notifications</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t466" class="mis show_mis"><span class="n"><a href="#t466">466</a></span><span class="t">        <span class="nam">num_auto_reconciled</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">automatic_reconciliation_entries</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t467" class="mis show_mis"><span class="n"><a href="#t467">467</a></span><span class="t">        <span class="key">if</span> <span class="nam">num_auto_reconciled</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t468" class="mis show_mis"><span class="n"><a href="#t468">468</a></span><span class="t">            <span class="nam">auto_reconciled_message</span> <span class="op">=</span> <span class="nam">num_auto_reconciled</span> <span class="op">></span> <span class="num">1</span> <span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t469" class="pln"><span class="n"><a href="#t469">469</a></span><span class="t">                <span class="key">and</span> <span class="nam">_</span><span class="op">(</span><span class="str">"%d transactions were automatically reconciled."</span><span class="op">)</span> <span class="op">%</span> <span class="nam">num_auto_reconciled</span> <span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t470" class="pln"><span class="n"><a href="#t470">470</a></span><span class="t">                <span class="key">or</span> <span class="nam">_</span><span class="op">(</span><span class="str">"1 transaction was automatically reconciled."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t471" class="mis show_mis"><span class="n"><a href="#t471">471</a></span><span class="t">            <span class="nam">notifications</span> <span class="op">+=</span> <span class="op">[</span><span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t472" class="pln"><span class="n"><a href="#t472">472</a></span><span class="t">                <span class="str">'type'</span><span class="op">:</span> <span class="str">'info'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t473" class="pln"><span class="n"><a href="#t473">473</a></span><span class="t">                <span class="str">'message'</span><span class="op">:</span> <span class="nam">auto_reconciled_message</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t474" class="pln"><span class="n"><a href="#t474">474</a></span><span class="t">                <span class="str">'details'</span><span class="op">:</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t475" class="pln"><span class="n"><a href="#t475">475</a></span><span class="t">                    <span class="str">'name'</span><span class="op">:</span> <span class="nam">_</span><span class="op">(</span><span class="str">"Automatically reconciled items"</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t476" class="pln"><span class="n"><a href="#t476">476</a></span><span class="t">                    <span class="str">'model'</span><span class="op">:</span> <span class="str">'account.move'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t477" class="pln"><span class="n"><a href="#t477">477</a></span><span class="t">                    <span class="str">'ids'</span><span class="op">:</span> <span class="nam">automatic_reconciliation_entries</span><span class="op">.</span><span class="nam">mapped</span><span class="op">(</span><span class="str">'journal_entry_ids'</span><span class="op">)</span><span class="op">.</span><span class="nam">ids</span>&nbsp;</span><span class="r"></span></p>
    <p id="t478" class="pln"><span class="n"><a href="#t478">478</a></span><span class="t">                <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t479" class="pln"><span class="n"><a href="#t479">479</a></span><span class="t">            <span class="op">}</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t480" class="mis show_mis"><span class="n"><a href="#t480">480</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t481" class="pln"><span class="n"><a href="#t481">481</a></span><span class="t">            <span class="str">'st_lines_ids'</span><span class="op">:</span> <span class="nam">unreconciled</span><span class="op">.</span><span class="nam">ids</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t482" class="pln"><span class="n"><a href="#t482">482</a></span><span class="t">            <span class="str">'notifications'</span><span class="op">:</span> <span class="nam">notifications</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t483" class="pln"><span class="n"><a href="#t483">483</a></span><span class="t">            <span class="str">'statement_name'</span><span class="op">:</span> <span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t484" class="pln"><span class="n"><a href="#t484">484</a></span><span class="t">            <span class="str">'num_already_reconciled_lines'</span><span class="op">:</span> <span class="nam">num_auto_reconciled</span> <span class="op">+</span> <span class="nam">num_already_reconciled_lines</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t485" class="pln"><span class="n"><a href="#t485">485</a></span><span class="t">        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t486" class="pln"><span class="n"><a href="#t486">486</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t487" class="run"><span class="n"><a href="#t487">487</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t488" class="run"><span class="n"><a href="#t488">488</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_data_for_reconciliation_widget</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">excluded_ids</span><span class="op">=</span><span class="nam">None</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t489" class="pln"><span class="n"><a href="#t489">489</a></span><span class="t">        <span class="str">""" Returns the data required to display a reconciliation widget, for each statement line in self """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t490" class="mis show_mis"><span class="n"><a href="#t490">490</a></span><span class="t">        <span class="nam">excluded_ids</span> <span class="op">=</span> <span class="nam">excluded_ids</span> <span class="key">or</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t491" class="mis show_mis"><span class="n"><a href="#t491">491</a></span><span class="t">        <span class="nam">ret</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t492" class="pln"><span class="n"><a href="#t492">492</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t493" class="mis show_mis"><span class="n"><a href="#t493">493</a></span><span class="t">        <span class="key">for</span> <span class="nam">st_line</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t494" class="mis show_mis"><span class="n"><a href="#t494">494</a></span><span class="t">            <span class="nam">aml_recs</span> <span class="op">=</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">get_reconciliation_proposition</span><span class="op">(</span><span class="nam">excluded_ids</span><span class="op">=</span><span class="nam">excluded_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t495" class="mis show_mis"><span class="n"><a href="#t495">495</a></span><span class="t">            <span class="nam">target_currency</span> <span class="op">=</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t496" class="mis show_mis"><span class="n"><a href="#t496">496</a></span><span class="t">            <span class="nam">rp</span> <span class="op">=</span> <span class="nam">aml_recs</span><span class="op">.</span><span class="nam">prepare_move_lines_for_reconciliation_widget</span><span class="op">(</span><span class="nam">target_currency</span><span class="op">=</span><span class="nam">target_currency</span><span class="op">,</span> <span class="nam">target_date</span><span class="op">=</span><span class="nam">st_line</span><span class="op">.</span><span class="nam">date</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t497" class="mis show_mis"><span class="n"><a href="#t497">497</a></span><span class="t">            <span class="nam">excluded_ids</span> <span class="op">+=</span> <span class="op">[</span><span class="nam">move_line</span><span class="op">[</span><span class="str">'id'</span><span class="op">]</span> <span class="key">for</span> <span class="nam">move_line</span> <span class="key">in</span> <span class="nam">rp</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t498" class="mis show_mis"><span class="n"><a href="#t498">498</a></span><span class="t">            <span class="nam">ret</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t499" class="pln"><span class="n"><a href="#t499">499</a></span><span class="t">                <span class="str">'st_line'</span><span class="op">:</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">get_statement_line_for_reconciliation_widget</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t500" class="pln"><span class="n"><a href="#t500">500</a></span><span class="t">                <span class="str">'reconciliation_proposition'</span><span class="op">:</span> <span class="nam">rp</span>&nbsp;</span><span class="r"></span></p>
    <p id="t501" class="pln"><span class="n"><a href="#t501">501</a></span><span class="t">            <span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t502" class="pln"><span class="n"><a href="#t502">502</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t503" class="mis show_mis"><span class="n"><a href="#t503">503</a></span><span class="t">        <span class="key">return</span> <span class="nam">ret</span>&nbsp;</span><span class="r"></span></p>
    <p id="t504" class="pln"><span class="n"><a href="#t504">504</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t505" class="run"><span class="n"><a href="#t505">505</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_statement_line_for_reconciliation_widget</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t506" class="pln"><span class="n"><a href="#t506">506</a></span><span class="t">        <span class="str">""" Returns the data required by the bank statement reconciliation widget to display a statement line """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t507" class="mis show_mis"><span class="n"><a href="#t507">507</a></span><span class="t">        <span class="nam">statement_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t508" class="mis show_mis"><span class="n"><a href="#t508">508</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount_currency</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t509" class="mis show_mis"><span class="n"><a href="#t509">509</a></span><span class="t">            <span class="nam">amount</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount_currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t510" class="mis show_mis"><span class="n"><a href="#t510">510</a></span><span class="t">            <span class="nam">amount_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount</span>&nbsp;</span><span class="r"></span></p>
    <p id="t511" class="mis show_mis"><span class="n"><a href="#t511">511</a></span><span class="t">            <span class="nam">amount_currency_str</span> <span class="op">=</span> <span class="nam">amount_currency</span> <span class="op">></span> <span class="num">0</span> <span class="key">and</span> <span class="nam">amount_currency</span> <span class="key">or</span> <span class="op">-</span><span class="nam">amount_currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t512" class="mis show_mis"><span class="n"><a href="#t512">512</a></span><span class="t">            <span class="nam">amount_currency_str</span> <span class="op">=</span> <span class="nam">formatLang</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">,</span> <span class="nam">amount_currency_str</span><span class="op">,</span> <span class="nam">currency_obj</span><span class="op">=</span><span class="nam">statement_currency</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t513" class="pln"><span class="n"><a href="#t513">513</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t514" class="mis show_mis"><span class="n"><a href="#t514">514</a></span><span class="t">            <span class="nam">amount</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount</span>&nbsp;</span><span class="r"></span></p>
    <p id="t515" class="mis show_mis"><span class="n"><a href="#t515">515</a></span><span class="t">            <span class="nam">amount_currency_str</span> <span class="op">=</span> <span class="str">""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t516" class="mis show_mis"><span class="n"><a href="#t516">516</a></span><span class="t">        <span class="nam">amount_str</span> <span class="op">=</span> <span class="nam">formatLang</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">,</span> <span class="nam">abs</span><span class="op">(</span><span class="nam">amount</span><span class="op">)</span><span class="op">,</span> <span class="nam">currency_obj</span><span class="op">=</span><span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">statement_currency</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t517" class="pln"><span class="n"><a href="#t517">517</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t518" class="mis show_mis"><span class="n"><a href="#t518">518</a></span><span class="t">        <span class="nam">data</span> <span class="op">=</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t519" class="pln"><span class="n"><a href="#t519">519</a></span><span class="t">            <span class="str">'id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t520" class="pln"><span class="n"><a href="#t520">520</a></span><span class="t">            <span class="str">'ref'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ref</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t521" class="pln"><span class="n"><a href="#t521">521</a></span><span class="t">            <span class="str">'note'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">note</span> <span class="key">or</span> <span class="str">""</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t522" class="pln"><span class="n"><a href="#t522">522</a></span><span class="t">            <span class="str">'name'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t523" class="pln"><span class="n"><a href="#t523">523</a></span><span class="t">            <span class="str">'date'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">date</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t524" class="pln"><span class="n"><a href="#t524">524</a></span><span class="t">            <span class="str">'amount'</span><span class="op">:</span> <span class="nam">amount</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t525" class="pln"><span class="n"><a href="#t525">525</a></span><span class="t">            <span class="str">'amount_str'</span><span class="op">:</span> <span class="nam">amount_str</span><span class="op">,</span>  <span class="com"># Amount in the statement line currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t526" class="pln"><span class="n"><a href="#t526">526</a></span><span class="t">            <span class="str">'currency_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">statement_currency</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t527" class="pln"><span class="n"><a href="#t527">527</a></span><span class="t">            <span class="str">'partner_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t528" class="pln"><span class="n"><a href="#t528">528</a></span><span class="t">            <span class="str">'journal_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t529" class="pln"><span class="n"><a href="#t529">529</a></span><span class="t">            <span class="str">'statement_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">statement_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t530" class="pln"><span class="n"><a href="#t530">530</a></span><span class="t">            <span class="str">'account_code'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_debit_account_id</span><span class="op">.</span><span class="nam">code</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t531" class="pln"><span class="n"><a href="#t531">531</a></span><span class="t">            <span class="str">'account_name'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_debit_account_id</span><span class="op">.</span><span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t532" class="pln"><span class="n"><a href="#t532">532</a></span><span class="t">            <span class="str">'partner_name'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t533" class="pln"><span class="n"><a href="#t533">533</a></span><span class="t">            <span class="str">'communication_partner_name'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t534" class="pln"><span class="n"><a href="#t534">534</a></span><span class="t">            <span class="str">'amount_currency_str'</span><span class="op">:</span> <span class="nam">amount_currency_str</span><span class="op">,</span>  <span class="com"># Amount in the statement currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t535" class="pln"><span class="n"><a href="#t535">535</a></span><span class="t">            <span class="str">'has_no_partner'</span><span class="op">:</span> <span class="key">not</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t536" class="pln"><span class="n"><a href="#t536">536</a></span><span class="t">        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t537" class="mis show_mis"><span class="n"><a href="#t537">537</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t538" class="mis show_mis"><span class="n"><a href="#t538">538</a></span><span class="t">            <span class="key">if</span> <span class="nam">amount</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t539" class="mis show_mis"><span class="n"><a href="#t539">539</a></span><span class="t">                <span class="nam">data</span><span class="op">[</span><span class="str">'open_balance_account_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">property_account_receivable_id</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t540" class="pln"><span class="n"><a href="#t540">540</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t541" class="mis show_mis"><span class="n"><a href="#t541">541</a></span><span class="t">                <span class="nam">data</span><span class="op">[</span><span class="str">'open_balance_account_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">property_account_payable_id</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t542" class="pln"><span class="n"><a href="#t542">542</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t543" class="mis show_mis"><span class="n"><a href="#t543">543</a></span><span class="t">        <span class="key">return</span> <span class="nam">data</span>&nbsp;</span><span class="r"></span></p>
    <p id="t544" class="pln"><span class="n"><a href="#t544">544</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t545" class="run"><span class="n"><a href="#t545">545</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t546" class="run"><span class="n"><a href="#t546">546</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_move_lines_for_reconciliation_widget</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">excluded_ids</span><span class="op">=</span><span class="nam">None</span><span class="op">,</span> <span class="nam">str</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">offset</span><span class="op">=</span><span class="num">0</span><span class="op">,</span> <span class="nam">limit</span><span class="op">=</span><span class="nam">None</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t547" class="pln"><span class="n"><a href="#t547">547</a></span><span class="t">        <span class="str">""" Returns move lines for the bank statement reconciliation widget, formatted as a list of dicts</span>&nbsp;</span><span class="r"></span></p>
    <p id="t548" class="pln"><span class="n"><a href="#t548">548</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t549" class="mis show_mis"><span class="n"><a href="#t549">549</a></span><span class="t">        <span class="nam">aml_recs</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_move_lines_for_reconciliation</span><span class="op">(</span><span class="nam">excluded_ids</span><span class="op">=</span><span class="nam">excluded_ids</span><span class="op">,</span> <span class="nam">str</span><span class="op">=</span><span class="nam">str</span><span class="op">,</span> <span class="nam">offset</span><span class="op">=</span><span class="nam">offset</span><span class="op">,</span> <span class="nam">limit</span><span class="op">=</span><span class="nam">limit</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t550" class="mis show_mis"><span class="n"><a href="#t550">550</a></span><span class="t">        <span class="nam">target_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t551" class="mis show_mis"><span class="n"><a href="#t551">551</a></span><span class="t">        <span class="key">return</span> <span class="nam">aml_recs</span><span class="op">.</span><span class="nam">prepare_move_lines_for_reconciliation_widget</span><span class="op">(</span><span class="nam">target_currency</span><span class="op">=</span><span class="nam">target_currency</span><span class="op">,</span> <span class="nam">target_date</span><span class="op">=</span><span class="nam">self</span><span class="op">.</span><span class="nam">date</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t552" class="pln"><span class="n"><a href="#t552">552</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t553" class="pln"><span class="n"><a href="#t553">553</a></span><span class="t">    <span class="com">####################################################</span>&nbsp;</span><span class="r"></span></p>
    <p id="t554" class="pln"><span class="n"><a href="#t554">554</a></span><span class="t">    <span class="com"># Reconciliation methods</span>&nbsp;</span><span class="r"></span></p>
    <p id="t555" class="pln"><span class="n"><a href="#t555">555</a></span><span class="t">    <span class="com">####################################################</span>&nbsp;</span><span class="r"></span></p>
    <p id="t556" class="pln"><span class="n"><a href="#t556">556</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t557" class="run"><span class="n"><a href="#t557">557</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_move_lines_for_reconciliation</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">excluded_ids</span><span class="op">=</span><span class="nam">None</span><span class="op">,</span> <span class="nam">str</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">offset</span><span class="op">=</span><span class="num">0</span><span class="op">,</span> <span class="nam">limit</span><span class="op">=</span><span class="nam">None</span><span class="op">,</span> <span class="nam">additional_domain</span><span class="op">=</span><span class="nam">None</span><span class="op">,</span> <span class="nam">overlook_partner</span><span class="op">=</span><span class="nam">False</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t558" class="pln"><span class="n"><a href="#t558">558</a></span><span class="t">        <span class="str">""" Return account.move.line records which can be used for bank statement reconciliation.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t559" class="pln"><span class="n"><a href="#t559">559</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t560" class="pln"><span class="n"><a href="#t560">560</a></span><span class="t"><span class="str">            :param excluded_ids:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t561" class="pln"><span class="n"><a href="#t561">561</a></span><span class="t"><span class="str">            :param str:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t562" class="pln"><span class="n"><a href="#t562">562</a></span><span class="t"><span class="str">            :param offset:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t563" class="pln"><span class="n"><a href="#t563">563</a></span><span class="t"><span class="str">            :param limit:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t564" class="pln"><span class="n"><a href="#t564">564</a></span><span class="t"><span class="str">            :param additional_domain:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t565" class="pln"><span class="n"><a href="#t565">565</a></span><span class="t"><span class="str">            :param overlook_partner:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t566" class="pln"><span class="n"><a href="#t566">566</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t567" class="pln"><span class="n"><a href="#t567">567</a></span><span class="t">        <span class="com"># Blue lines = payment on bank account not assigned to a statement yet</span>&nbsp;</span><span class="r"></span></p>
    <p id="t568" class="mis show_mis"><span class="n"><a href="#t568">568</a></span><span class="t">        <span class="nam">reconciliation_aml_accounts</span> <span class="op">=</span> <span class="op">[</span><span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_credit_account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_debit_account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t569" class="mis show_mis"><span class="n"><a href="#t569">569</a></span><span class="t">        <span class="nam">domain_reconciliation</span> <span class="op">=</span> <span class="op">[</span><span class="str">'&amp;'</span><span class="op">,</span> <span class="op">(</span><span class="str">'statement_id'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="str">'account_id'</span><span class="op">,</span> <span class="str">'in'</span><span class="op">,</span> <span class="nam">reconciliation_aml_accounts</span><span class="op">)</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t570" class="pln"><span class="n"><a href="#t570">570</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t571" class="pln"><span class="n"><a href="#t571">571</a></span><span class="t">        <span class="com"># Black lines = unreconciled &amp; (not linked to a payment or open balance created by statement</span>&nbsp;</span><span class="r"></span></p>
    <p id="t572" class="mis show_mis"><span class="n"><a href="#t572">572</a></span><span class="t">        <span class="nam">domain_matching</span> <span class="op">=</span> <span class="op">[</span><span class="op">(</span><span class="str">'reconciled'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">False</span><span class="op">)</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t573" class="mis show_mis"><span class="n"><a href="#t573">573</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">overlook_partner</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t574" class="mis show_mis"><span class="n"><a href="#t574">574</a></span><span class="t">            <span class="nam">domain_matching</span> <span class="op">=</span> <span class="nam">expression</span><span class="op">.</span><span class="nam">AND</span><span class="op">(</span><span class="op">[</span><span class="nam">domain_matching</span><span class="op">,</span> <span class="op">[</span><span class="op">(</span><span class="str">'account_id.internal_type'</span><span class="op">,</span> <span class="str">'in'</span><span class="op">,</span> <span class="op">[</span><span class="str">'payable'</span><span class="op">,</span> <span class="str">'receivable'</span><span class="op">]</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t575" class="pln"><span class="n"><a href="#t575">575</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t576" class="pln"><span class="n"><a href="#t576">576</a></span><span class="t">            <span class="com"># TODO : find out what use case this permits (match a check payment, registered on a journal whose account type is other instead of liquidity)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t577" class="mis show_mis"><span class="n"><a href="#t577">577</a></span><span class="t">            <span class="nam">domain_matching</span> <span class="op">=</span> <span class="nam">expression</span><span class="op">.</span><span class="nam">AND</span><span class="op">(</span><span class="op">[</span><span class="nam">domain_matching</span><span class="op">,</span> <span class="op">[</span><span class="op">(</span><span class="str">'account_id.reconcile'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">True</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t578" class="pln"><span class="n"><a href="#t578">578</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t579" class="pln"><span class="n"><a href="#t579">579</a></span><span class="t">        <span class="com"># Let's add what applies to both</span>&nbsp;</span><span class="r"></span></p>
    <p id="t580" class="mis show_mis"><span class="n"><a href="#t580">580</a></span><span class="t">        <span class="nam">domain</span> <span class="op">=</span> <span class="nam">expression</span><span class="op">.</span><span class="nam">OR</span><span class="op">(</span><span class="op">[</span><span class="nam">domain_reconciliation</span><span class="op">,</span> <span class="nam">domain_matching</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t581" class="mis show_mis"><span class="n"><a href="#t581">581</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">id</span> <span class="key">and</span> <span class="key">not</span> <span class="nam">overlook_partner</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t582" class="mis show_mis"><span class="n"><a href="#t582">582</a></span><span class="t">            <span class="nam">domain</span> <span class="op">=</span> <span class="nam">expression</span><span class="op">.</span><span class="nam">AND</span><span class="op">(</span><span class="op">[</span><span class="nam">domain</span><span class="op">,</span> <span class="op">[</span><span class="op">(</span><span class="str">'partner_id'</span><span class="op">,</span> <span class="str">'='</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t583" class="pln"><span class="n"><a href="#t583">583</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t584" class="pln"><span class="n"><a href="#t584">584</a></span><span class="t">        <span class="com"># Domain factorized for all reconciliation use cases</span>&nbsp;</span><span class="r"></span></p>
    <p id="t585" class="mis show_mis"><span class="n"><a href="#t585">585</a></span><span class="t">        <span class="nam">ctx</span> <span class="op">=</span> <span class="nam">dict</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">_context</span> <span class="key">or</span> <span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t586" class="mis show_mis"><span class="n"><a href="#t586">586</a></span><span class="t">        <span class="nam">ctx</span><span class="op">[</span><span class="str">'bank_statement_line'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span>&nbsp;</span><span class="r"></span></p>
    <p id="t587" class="mis show_mis"><span class="n"><a href="#t587">587</a></span><span class="t">        <span class="nam">generic_domain</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">ctx</span><span class="op">)</span><span class="op">.</span><span class="nam">domain_move_lines_for_reconciliation</span><span class="op">(</span><span class="nam">excluded_ids</span><span class="op">=</span><span class="nam">excluded_ids</span><span class="op">,</span> <span class="nam">str</span><span class="op">=</span><span class="nam">str</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t588" class="mis show_mis"><span class="n"><a href="#t588">588</a></span><span class="t">        <span class="nam">domain</span> <span class="op">=</span> <span class="nam">expression</span><span class="op">.</span><span class="nam">AND</span><span class="op">(</span><span class="op">[</span><span class="nam">domain</span><span class="op">,</span> <span class="nam">generic_domain</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t589" class="pln"><span class="n"><a href="#t589">589</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t590" class="pln"><span class="n"><a href="#t590">590</a></span><span class="t">        <span class="com"># Domain from caller</span>&nbsp;</span><span class="r"></span></p>
    <p id="t591" class="mis show_mis"><span class="n"><a href="#t591">591</a></span><span class="t">        <span class="key">if</span> <span class="nam">additional_domain</span> <span class="key">is</span> <span class="nam">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t592" class="mis show_mis"><span class="n"><a href="#t592">592</a></span><span class="t">            <span class="nam">additional_domain</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t593" class="pln"><span class="n"><a href="#t593">593</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t594" class="mis show_mis"><span class="n"><a href="#t594">594</a></span><span class="t">            <span class="nam">additional_domain</span> <span class="op">=</span> <span class="nam">expression</span><span class="op">.</span><span class="nam">normalize_domain</span><span class="op">(</span><span class="nam">additional_domain</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t595" class="mis show_mis"><span class="n"><a href="#t595">595</a></span><span class="t">        <span class="nam">domain</span> <span class="op">=</span> <span class="nam">expression</span><span class="op">.</span><span class="nam">AND</span><span class="op">(</span><span class="op">[</span><span class="nam">domain</span><span class="op">,</span> <span class="nam">additional_domain</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t596" class="pln"><span class="n"><a href="#t596">596</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t597" class="mis show_mis"><span class="n"><a href="#t597">597</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span><span class="op">.</span><span class="nam">search</span><span class="op">(</span><span class="nam">domain</span><span class="op">,</span> <span class="nam">offset</span><span class="op">=</span><span class="nam">offset</span><span class="op">,</span> <span class="nam">limit</span><span class="op">=</span><span class="nam">limit</span><span class="op">,</span> <span class="nam">order</span><span class="op">=</span><span class="str">"date_maturity asc, id asc"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t598" class="pln"><span class="n"><a href="#t598">598</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t599" class="run"><span class="n"><a href="#t599">599</a></span><span class="t">    <span class="key">def</span> <span class="nam">_get_common_sql_query</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">overlook_partner</span> <span class="op">=</span> <span class="nam">False</span><span class="op">,</span> <span class="nam">excluded_ids</span> <span class="op">=</span> <span class="nam">None</span><span class="op">,</span> <span class="nam">split</span> <span class="op">=</span> <span class="nam">False</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t600" class="mis show_mis"><span class="n"><a href="#t600">600</a></span><span class="t">        <span class="nam">acc_type</span> <span class="op">=</span> <span class="str">"acc.internal_type IN ('payable', 'receivable')"</span> <span class="key">if</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span> <span class="key">or</span> <span class="nam">overlook_partner</span><span class="op">)</span> <span class="key">else</span> <span class="str">"acc.reconcile = true"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t601" class="mis show_mis"><span class="n"><a href="#t601">601</a></span><span class="t">        <span class="nam">select_clause</span> <span class="op">=</span> <span class="str">"SELECT aml.id "</span>&nbsp;</span><span class="r"></span></p>
    <p id="t602" class="mis show_mis"><span class="n"><a href="#t602">602</a></span><span class="t">        <span class="nam">from_clause</span> <span class="op">=</span> <span class="str">"FROM account_move_line aml JOIN account_account acc ON acc.id = aml.account_id "</span>&nbsp;</span><span class="r"></span></p>
    <p id="t603" class="mis show_mis"><span class="n"><a href="#t603">603</a></span><span class="t">        <span class="nam">account_clause</span> <span class="op">=</span> <span class="str">''</span>&nbsp;</span><span class="r"></span></p>
    <p id="t604" class="mis show_mis"><span class="n"><a href="#t604">604</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_credit_account_id</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_debit_account_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t605" class="mis show_mis"><span class="n"><a href="#t605">605</a></span><span class="t">            <span class="nam">account_clause</span> <span class="op">=</span> <span class="str">"(aml.statement_id IS NULL AND aml.account_id IN %(account_payable_receivable)s AND aml.payment_id IS NOT NULL) OR"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t606" class="mis show_mis"><span class="n"><a href="#t606">606</a></span><span class="t">        <span class="nam">where_clause</span> <span class="op">=</span> <span class="str">"""WHERE aml.company_id = %(company_id)s</span>&nbsp;</span><span class="r"></span></p>
    <p id="t607" class="pln"><span class="n"><a href="#t607">607</a></span><span class="t"><span class="str">                          AND (</span>&nbsp;</span><span class="r"></span></p>
    <p id="t608" class="pln"><span class="n"><a href="#t608">608</a></span><span class="t"><span class="str">                                    """</span> <span class="op">+</span> <span class="nam">account_clause</span> <span class="op">+</span> <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t609" class="pln"><span class="n"><a href="#t609">609</a></span><span class="t"><span class="str">                                    ("""</span><span class="op">+</span><span class="nam">acc_type</span><span class="op">+</span><span class="str">""" AND aml.reconciled = false)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t610" class="pln"><span class="n"><a href="#t610">610</a></span><span class="t"><span class="str">                          )"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t611" class="mis show_mis"><span class="n"><a href="#t611">611</a></span><span class="t">        <span class="nam">where_clause</span> <span class="op">=</span> <span class="nam">where_clause</span> <span class="op">+</span> <span class="str">' AND aml.partner_id = %(partner_id)s'</span> <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span> <span class="key">else</span> <span class="nam">where_clause</span>&nbsp;</span><span class="r"></span></p>
    <p id="t612" class="mis show_mis"><span class="n"><a href="#t612">612</a></span><span class="t">        <span class="nam">where_clause</span> <span class="op">=</span> <span class="nam">where_clause</span> <span class="op">+</span> <span class="str">' AND aml.id NOT IN %(excluded_ids)s'</span> <span class="key">if</span> <span class="nam">excluded_ids</span> <span class="key">else</span> <span class="nam">where_clause</span>&nbsp;</span><span class="r"></span></p>
    <p id="t613" class="mis show_mis"><span class="n"><a href="#t613">613</a></span><span class="t">        <span class="key">if</span> <span class="nam">split</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t614" class="mis show_mis"><span class="n"><a href="#t614">614</a></span><span class="t">            <span class="key">return</span> <span class="nam">select_clause</span><span class="op">,</span> <span class="nam">from_clause</span><span class="op">,</span> <span class="nam">where_clause</span>&nbsp;</span><span class="r"></span></p>
    <p id="t615" class="mis show_mis"><span class="n"><a href="#t615">615</a></span><span class="t">        <span class="key">return</span> <span class="nam">select_clause</span> <span class="op">+</span> <span class="nam">from_clause</span> <span class="op">+</span> <span class="nam">where_clause</span>&nbsp;</span><span class="r"></span></p>
    <p id="t616" class="pln"><span class="n"><a href="#t616">616</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t617" class="run"><span class="n"><a href="#t617">617</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_reconciliation_proposition</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">excluded_ids</span><span class="op">=</span><span class="nam">None</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t618" class="pln"><span class="n"><a href="#t618">618</a></span><span class="t">        <span class="str">""" Returns move lines that constitute the best guess to reconcile a statement line</span>&nbsp;</span><span class="r"></span></p>
    <p id="t619" class="pln"><span class="n"><a href="#t619">619</a></span><span class="t"><span class="str">            Note: it only looks for move lines in the same currency as the statement line.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t620" class="pln"><span class="n"><a href="#t620">620</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t621" class="mis show_mis"><span class="n"><a href="#t621">621</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">ensure_one</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t622" class="mis show_mis"><span class="n"><a href="#t622">622</a></span><span class="t">        <span class="key">if</span> <span class="key">not</span> <span class="nam">excluded_ids</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t623" class="mis show_mis"><span class="n"><a href="#t623">623</a></span><span class="t">            <span class="nam">excluded_ids</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t624" class="mis show_mis"><span class="n"><a href="#t624">624</a></span><span class="t">        <span class="nam">amount</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount_currency</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount</span>&nbsp;</span><span class="r"></span></p>
    <p id="t625" class="mis show_mis"><span class="n"><a href="#t625">625</a></span><span class="t">        <span class="nam">company_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t626" class="mis show_mis"><span class="n"><a href="#t626">626</a></span><span class="t">        <span class="nam">st_line_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t627" class="mis show_mis"><span class="n"><a href="#t627">627</a></span><span class="t">        <span class="nam">currency</span> <span class="op">=</span> <span class="op">(</span><span class="nam">st_line_currency</span> <span class="key">and</span> <span class="nam">st_line_currency</span> <span class="op">!=</span> <span class="nam">company_currency</span><span class="op">)</span> <span class="key">and</span> <span class="nam">st_line_currency</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t628" class="mis show_mis"><span class="n"><a href="#t628">628</a></span><span class="t">        <span class="nam">precision</span> <span class="op">=</span> <span class="nam">st_line_currency</span> <span class="key">and</span> <span class="nam">st_line_currency</span><span class="op">.</span><span class="nam">decimal_places</span> <span class="key">or</span> <span class="nam">company_currency</span><span class="op">.</span><span class="nam">decimal_places</span>&nbsp;</span><span class="r"></span></p>
    <p id="t629" class="mis show_mis"><span class="n"><a href="#t629">629</a></span><span class="t">        <span class="nam">params</span> <span class="op">=</span> <span class="op">{</span><span class="str">'company_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">user</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t630" class="pln"><span class="n"><a href="#t630">630</a></span><span class="t">                    <span class="str">'account_payable_receivable'</span><span class="op">:</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_credit_account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_debit_account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t631" class="pln"><span class="n"><a href="#t631">631</a></span><span class="t">                    <span class="str">'amount'</span><span class="op">:</span> <span class="nam">float_repr</span><span class="op">(</span><span class="nam">float_round</span><span class="op">(</span><span class="nam">amount</span><span class="op">,</span> <span class="nam">precision_digits</span><span class="op">=</span><span class="nam">precision</span><span class="op">)</span><span class="op">,</span> <span class="nam">precision_digits</span><span class="op">=</span><span class="nam">precision</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t632" class="pln"><span class="n"><a href="#t632">632</a></span><span class="t">                    <span class="str">'partner_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t633" class="pln"><span class="n"><a href="#t633">633</a></span><span class="t">                    <span class="str">'excluded_ids'</span><span class="op">:</span> <span class="nam">tuple</span><span class="op">(</span><span class="nam">excluded_ids</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t634" class="pln"><span class="n"><a href="#t634">634</a></span><span class="t">                    <span class="str">'ref'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t635" class="pln"><span class="n"><a href="#t635">635</a></span><span class="t">                    <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t636" class="pln"><span class="n"><a href="#t636">636</a></span><span class="t">        <span class="com"># Look for structured communication match</span>&nbsp;</span><span class="r"></span></p>
    <p id="t637" class="mis show_mis"><span class="n"><a href="#t637">637</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">name</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t638" class="mis show_mis"><span class="n"><a href="#t638">638</a></span><span class="t">            <span class="nam">add_to_select</span> <span class="op">=</span> <span class="str">", CASE WHEN aml.ref = %(ref)s THEN 1 ELSE 2 END as temp_field_order "</span>&nbsp;</span><span class="r"></span></p>
    <p id="t639" class="mis show_mis"><span class="n"><a href="#t639">639</a></span><span class="t">            <span class="nam">add_to_from</span> <span class="op">=</span> <span class="str">" JOIN account_move m ON m.id = aml.move_id "</span>&nbsp;</span><span class="r"></span></p>
    <p id="t640" class="mis show_mis"><span class="n"><a href="#t640">640</a></span><span class="t">            <span class="nam">select_clause</span><span class="op">,</span> <span class="nam">from_clause</span><span class="op">,</span> <span class="nam">where_clause</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_common_sql_query</span><span class="op">(</span><span class="nam">overlook_partner</span><span class="op">=</span><span class="nam">True</span><span class="op">,</span> <span class="nam">excluded_ids</span><span class="op">=</span><span class="nam">excluded_ids</span><span class="op">,</span> <span class="nam">split</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t641" class="mis show_mis"><span class="n"><a href="#t641">641</a></span><span class="t">            <span class="nam">sql_query</span> <span class="op">=</span> <span class="nam">select_clause</span> <span class="op">+</span> <span class="nam">add_to_select</span> <span class="op">+</span> <span class="nam">from_clause</span> <span class="op">+</span> <span class="nam">add_to_from</span> <span class="op">+</span> <span class="nam">where_clause</span>&nbsp;</span><span class="r"></span></p>
    <p id="t642" class="mis show_mis"><span class="n"><a href="#t642">642</a></span><span class="t">            <span class="nam">sql_query</span> <span class="op">+=</span> <span class="str">" AND (aml.ref= %(ref)s or m.name = %(ref)s) \</span>&nbsp;</span><span class="r"></span></p>
    <p id="t643" class="pln"><span class="n"><a href="#t643">643</a></span><span class="t"><span class="str">                    ORDER BY temp_field_order, date_maturity asc, aml.id asc"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t644" class="mis show_mis"><span class="n"><a href="#t644">644</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">cr</span><span class="op">.</span><span class="nam">execute</span><span class="op">(</span><span class="nam">sql_query</span><span class="op">,</span> <span class="nam">params</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t645" class="mis show_mis"><span class="n"><a href="#t645">645</a></span><span class="t">            <span class="nam">results</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">cr</span><span class="op">.</span><span class="nam">fetchone</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t646" class="mis show_mis"><span class="n"><a href="#t646">646</a></span><span class="t">            <span class="key">if</span> <span class="nam">results</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t647" class="mis show_mis"><span class="n"><a href="#t647">647</a></span><span class="t">                <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span><span class="op">.</span><span class="nam">browse</span><span class="op">(</span><span class="nam">results</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t648" class="pln"><span class="n"><a href="#t648">648</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t649" class="pln"><span class="n"><a href="#t649">649</a></span><span class="t">        <span class="com"># Look for a single move line with the same amount</span>&nbsp;</span><span class="r"></span></p>
    <p id="t650" class="mis show_mis"><span class="n"><a href="#t650">650</a></span><span class="t">        <span class="nam">field</span> <span class="op">=</span> <span class="nam">currency</span> <span class="key">and</span> <span class="str">'amount_residual_currency'</span> <span class="key">or</span> <span class="str">'amount_residual'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t651" class="mis show_mis"><span class="n"><a href="#t651">651</a></span><span class="t">        <span class="nam">liquidity_field</span> <span class="op">=</span> <span class="nam">currency</span> <span class="key">and</span> <span class="str">'amount_currency'</span> <span class="key">or</span> <span class="nam">amount</span> <span class="op">></span> <span class="num">0</span> <span class="key">and</span> <span class="str">'debit'</span> <span class="key">or</span> <span class="str">'credit'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t652" class="mis show_mis"><span class="n"><a href="#t652">652</a></span><span class="t">        <span class="nam">liquidity_amt_clause</span> <span class="op">=</span> <span class="nam">currency</span> <span class="key">and</span> <span class="str">'%(amount)s::numeric'</span> <span class="key">or</span> <span class="str">'abs(%(amount)s::numeric)'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t653" class="mis show_mis"><span class="n"><a href="#t653">653</a></span><span class="t">        <span class="nam">sql_query</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_common_sql_query</span><span class="op">(</span><span class="nam">excluded_ids</span><span class="op">=</span><span class="nam">excluded_ids</span><span class="op">)</span> <span class="op">+</span> <span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t654" class="pln"><span class="n"><a href="#t654">654</a></span><span class="t">                <span class="str">" AND ("</span><span class="op">+</span><span class="nam">field</span><span class="op">+</span><span class="str">" = %(amount)s::numeric OR (acc.internal_type = 'liquidity' AND "</span><span class="op">+</span><span class="nam">liquidity_field</span><span class="op">+</span><span class="str">" = "</span> <span class="op">+</span> <span class="nam">liquidity_amt_clause</span> <span class="op">+</span> <span class="str">")) \</span>&nbsp;</span><span class="r"></span></p>
    <p id="t655" class="pln"><span class="n"><a href="#t655">655</a></span><span class="t"><span class="str">                ORDER BY date_maturity asc, aml.id asc LIMIT 1"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t656" class="mis show_mis"><span class="n"><a href="#t656">656</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">cr</span><span class="op">.</span><span class="nam">execute</span><span class="op">(</span><span class="nam">sql_query</span><span class="op">,</span> <span class="nam">params</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t657" class="mis show_mis"><span class="n"><a href="#t657">657</a></span><span class="t">        <span class="nam">results</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">cr</span><span class="op">.</span><span class="nam">fetchone</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t658" class="mis show_mis"><span class="n"><a href="#t658">658</a></span><span class="t">        <span class="key">if</span> <span class="nam">results</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t659" class="mis show_mis"><span class="n"><a href="#t659">659</a></span><span class="t">            <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span><span class="op">.</span><span class="nam">browse</span><span class="op">(</span><span class="nam">results</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t660" class="pln"><span class="n"><a href="#t660">660</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t661" class="mis show_mis"><span class="n"><a href="#t661">661</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t662" class="pln"><span class="n"><a href="#t662">662</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t663" class="run"><span class="n"><a href="#t663">663</a></span><span class="t">    <span class="key">def</span> <span class="nam">_get_move_lines_for_auto_reconcile</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t664" class="pln"><span class="n"><a href="#t664">664</a></span><span class="t">        <span class="str">""" Returns the move lines that the method auto_reconcile can use to try to reconcile the statement line """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t665" class="mis show_mis"><span class="n"><a href="#t665">665</a></span><span class="t">        <span class="key">pass</span>&nbsp;</span><span class="r"></span></p>
    <p id="t666" class="pln"><span class="n"><a href="#t666">666</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t667" class="run"><span class="n"><a href="#t667">667</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t668" class="pln"><span class="n"><a href="#t668">668</a></span><span class="t">    <span class="key">def</span> <span class="nam">auto_reconcile</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t669" class="pln"><span class="n"><a href="#t669">669</a></span><span class="t">        <span class="str">""" Try to automatically reconcile the statement.line ; return the counterpart journal entry/ies if the automatic reconciliation succeeded, False otherwise.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t670" class="pln"><span class="n"><a href="#t670">670</a></span><span class="t"><span class="str">            TODO : this method could be greatly improved and made extensible</span>&nbsp;</span><span class="r"></span></p>
    <p id="t671" class="pln"><span class="n"><a href="#t671">671</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t672" class="mis show_mis"><span class="n"><a href="#t672">672</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">ensure_one</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t673" class="mis show_mis"><span class="n"><a href="#t673">673</a></span><span class="t">        <span class="nam">match_recs</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t674" class="pln"><span class="n"><a href="#t674">674</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t675" class="mis show_mis"><span class="n"><a href="#t675">675</a></span><span class="t">        <span class="nam">amount</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount_currency</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount</span>&nbsp;</span><span class="r"></span></p>
    <p id="t676" class="mis show_mis"><span class="n"><a href="#t676">676</a></span><span class="t">        <span class="nam">company_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t677" class="mis show_mis"><span class="n"><a href="#t677">677</a></span><span class="t">        <span class="nam">st_line_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t678" class="mis show_mis"><span class="n"><a href="#t678">678</a></span><span class="t">        <span class="nam">currency</span> <span class="op">=</span> <span class="op">(</span><span class="nam">st_line_currency</span> <span class="key">and</span> <span class="nam">st_line_currency</span> <span class="op">!=</span> <span class="nam">company_currency</span><span class="op">)</span> <span class="key">and</span> <span class="nam">st_line_currency</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t679" class="mis show_mis"><span class="n"><a href="#t679">679</a></span><span class="t">        <span class="nam">precision</span> <span class="op">=</span> <span class="nam">st_line_currency</span> <span class="key">and</span> <span class="nam">st_line_currency</span><span class="op">.</span><span class="nam">decimal_places</span> <span class="key">or</span> <span class="nam">company_currency</span><span class="op">.</span><span class="nam">decimal_places</span>&nbsp;</span><span class="r"></span></p>
    <p id="t680" class="mis show_mis"><span class="n"><a href="#t680">680</a></span><span class="t">        <span class="nam">params</span> <span class="op">=</span> <span class="op">{</span><span class="str">'company_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">user</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t681" class="pln"><span class="n"><a href="#t681">681</a></span><span class="t">                    <span class="str">'account_payable_receivable'</span><span class="op">:</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_credit_account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_debit_account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t682" class="pln"><span class="n"><a href="#t682">682</a></span><span class="t">                    <span class="str">'amount'</span><span class="op">:</span> <span class="nam">float_round</span><span class="op">(</span><span class="nam">amount</span><span class="op">,</span> <span class="nam">precision_digits</span><span class="op">=</span><span class="nam">precision</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t683" class="pln"><span class="n"><a href="#t683">683</a></span><span class="t">                    <span class="str">'partner_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t684" class="pln"><span class="n"><a href="#t684">684</a></span><span class="t">                    <span class="str">'ref'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t685" class="pln"><span class="n"><a href="#t685">685</a></span><span class="t">                    <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t686" class="mis show_mis"><span class="n"><a href="#t686">686</a></span><span class="t">        <span class="nam">field</span> <span class="op">=</span> <span class="nam">currency</span> <span class="key">and</span> <span class="str">'amount_residual_currency'</span> <span class="key">or</span> <span class="str">'amount_residual'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t687" class="mis show_mis"><span class="n"><a href="#t687">687</a></span><span class="t">        <span class="nam">liquidity_field</span> <span class="op">=</span> <span class="nam">currency</span> <span class="key">and</span> <span class="str">'amount_currency'</span> <span class="key">or</span> <span class="nam">amount</span> <span class="op">></span> <span class="num">0</span> <span class="key">and</span> <span class="str">'debit'</span> <span class="key">or</span> <span class="str">'credit'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t688" class="pln"><span class="n"><a href="#t688">688</a></span><span class="t">        <span class="com"># Look for structured communication match</span>&nbsp;</span><span class="r"></span></p>
    <p id="t689" class="mis show_mis"><span class="n"><a href="#t689">689</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">name</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t690" class="mis show_mis"><span class="n"><a href="#t690">690</a></span><span class="t">            <span class="nam">sql_query</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_common_sql_query</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t691" class="pln"><span class="n"><a href="#t691">691</a></span><span class="t">                <span class="str">" AND aml.ref = %(ref)s AND ("</span><span class="op">+</span><span class="nam">field</span><span class="op">+</span><span class="str">" = %(amount)s OR (acc.internal_type = 'liquidity' AND "</span><span class="op">+</span><span class="nam">liquidity_field</span><span class="op">+</span><span class="str">" = %(amount)s)) \</span>&nbsp;</span><span class="r"></span></p>
    <p id="t692" class="pln"><span class="n"><a href="#t692">692</a></span><span class="t"><span class="str">                ORDER BY date_maturity asc, aml.id asc"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t693" class="mis show_mis"><span class="n"><a href="#t693">693</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">cr</span><span class="op">.</span><span class="nam">execute</span><span class="op">(</span><span class="nam">sql_query</span><span class="op">,</span> <span class="nam">params</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t694" class="mis show_mis"><span class="n"><a href="#t694">694</a></span><span class="t">            <span class="nam">match_recs</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">cr</span><span class="op">.</span><span class="nam">dictfetchall</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t695" class="mis show_mis"><span class="n"><a href="#t695">695</a></span><span class="t">            <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">match_recs</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t696" class="mis show_mis"><span class="n"><a href="#t696">696</a></span><span class="t">                <span class="key">return</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t697" class="pln"><span class="n"><a href="#t697">697</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t698" class="pln"><span class="n"><a href="#t698">698</a></span><span class="t">        <span class="com"># Look for a single move line with the same partner, the same amount</span>&nbsp;</span><span class="r"></span></p>
    <p id="t699" class="mis show_mis"><span class="n"><a href="#t699">699</a></span><span class="t">        <span class="key">if</span> <span class="key">not</span> <span class="nam">match_recs</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t700" class="mis show_mis"><span class="n"><a href="#t700">700</a></span><span class="t">            <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t701" class="mis show_mis"><span class="n"><a href="#t701">701</a></span><span class="t">                <span class="nam">sql_query</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_common_sql_query</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t702" class="pln"><span class="n"><a href="#t702">702</a></span><span class="t">                <span class="str">" AND ("</span><span class="op">+</span><span class="nam">field</span><span class="op">+</span><span class="str">" = %(amount)s OR (acc.internal_type = 'liquidity' AND "</span><span class="op">+</span><span class="nam">liquidity_field</span><span class="op">+</span><span class="str">" = %(amount)s)) \</span>&nbsp;</span><span class="r"></span></p>
    <p id="t703" class="pln"><span class="n"><a href="#t703">703</a></span><span class="t"><span class="str">                ORDER BY date_maturity asc, aml.id asc"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t704" class="mis show_mis"><span class="n"><a href="#t704">704</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">cr</span><span class="op">.</span><span class="nam">execute</span><span class="op">(</span><span class="nam">sql_query</span><span class="op">,</span> <span class="nam">params</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t705" class="mis show_mis"><span class="n"><a href="#t705">705</a></span><span class="t">                <span class="nam">match_recs</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">.</span><span class="nam">cr</span><span class="op">.</span><span class="nam">dictfetchall</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t706" class="mis show_mis"><span class="n"><a href="#t706">706</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">match_recs</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t707" class="mis show_mis"><span class="n"><a href="#t707">707</a></span><span class="t">                    <span class="key">return</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t708" class="pln"><span class="n"><a href="#t708">708</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t709" class="mis show_mis"><span class="n"><a href="#t709">709</a></span><span class="t">        <span class="key">if</span> <span class="key">not</span> <span class="nam">match_recs</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t710" class="mis show_mis"><span class="n"><a href="#t710">710</a></span><span class="t">            <span class="key">return</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t711" class="pln"><span class="n"><a href="#t711">711</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t712" class="mis show_mis"><span class="n"><a href="#t712">712</a></span><span class="t">        <span class="nam">match_recs</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span><span class="op">.</span><span class="nam">browse</span><span class="op">(</span><span class="op">[</span><span class="nam">aml</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'id'</span><span class="op">)</span> <span class="key">for</span> <span class="nam">aml</span> <span class="key">in</span> <span class="nam">match_recs</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t713" class="pln"><span class="n"><a href="#t713">713</a></span><span class="t">        <span class="com"># Now reconcile</span>&nbsp;</span><span class="r"></span></p>
    <p id="t714" class="mis show_mis"><span class="n"><a href="#t714">714</a></span><span class="t">        <span class="nam">counterpart_aml_dicts</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t715" class="mis show_mis"><span class="n"><a href="#t715">715</a></span><span class="t">        <span class="nam">payment_aml_rec</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t716" class="mis show_mis"><span class="n"><a href="#t716">716</a></span><span class="t">        <span class="key">for</span> <span class="nam">aml</span> <span class="key">in</span> <span class="nam">match_recs</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t717" class="mis show_mis"><span class="n"><a href="#t717">717</a></span><span class="t">            <span class="key">if</span> <span class="nam">aml</span><span class="op">.</span><span class="nam">account_id</span><span class="op">.</span><span class="nam">internal_type</span> <span class="op">==</span> <span class="str">'liquidity'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t718" class="mis show_mis"><span class="n"><a href="#t718">718</a></span><span class="t">                <span class="nam">payment_aml_rec</span> <span class="op">=</span> <span class="op">(</span><span class="nam">payment_aml_rec</span> <span class="op">|</span> <span class="nam">aml</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t719" class="pln"><span class="n"><a href="#t719">719</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t720" class="mis show_mis"><span class="n"><a href="#t720">720</a></span><span class="t">                <span class="nam">amount</span> <span class="op">=</span> <span class="nam">aml</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">and</span> <span class="nam">aml</span><span class="op">.</span><span class="nam">amount_residual_currency</span> <span class="key">or</span> <span class="nam">aml</span><span class="op">.</span><span class="nam">amount_residual</span>&nbsp;</span><span class="r"></span></p>
    <p id="t721" class="mis show_mis"><span class="n"><a href="#t721">721</a></span><span class="t">                <span class="nam">counterpart_aml_dicts</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t722" class="pln"><span class="n"><a href="#t722">722</a></span><span class="t">                    <span class="str">'name'</span><span class="op">:</span> <span class="nam">aml</span><span class="op">.</span><span class="nam">name</span> <span class="key">if</span> <span class="nam">aml</span><span class="op">.</span><span class="nam">name</span> <span class="op">!=</span> <span class="str">'/'</span> <span class="key">else</span> <span class="nam">aml</span><span class="op">.</span><span class="nam">move_id</span><span class="op">.</span><span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t723" class="pln"><span class="n"><a href="#t723">723</a></span><span class="t">                    <span class="str">'debit'</span><span class="op">:</span> <span class="nam">amount</span> <span class="op">&lt;</span> <span class="num">0</span> <span class="key">and</span> <span class="op">-</span><span class="nam">amount</span> <span class="key">or</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t724" class="pln"><span class="n"><a href="#t724">724</a></span><span class="t">                    <span class="str">'credit'</span><span class="op">:</span> <span class="nam">amount</span> <span class="op">></span> <span class="num">0</span> <span class="key">and</span> <span class="nam">amount</span> <span class="key">or</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t725" class="pln"><span class="n"><a href="#t725">725</a></span><span class="t">                    <span class="str">'move_line'</span><span class="op">:</span> <span class="nam">aml</span>&nbsp;</span><span class="r"></span></p>
    <p id="t726" class="pln"><span class="n"><a href="#t726">726</a></span><span class="t">                <span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t727" class="pln"><span class="n"><a href="#t727">727</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t728" class="mis show_mis"><span class="n"><a href="#t728">728</a></span><span class="t">        <span class="key">try</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t729" class="mis show_mis"><span class="n"><a href="#t729">729</a></span><span class="t">            <span class="key">with</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_cr</span><span class="op">.</span><span class="nam">savepoint</span><span class="op">(</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t730" class="mis show_mis"><span class="n"><a href="#t730">730</a></span><span class="t">                <span class="nam">counterpart</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">process_reconciliation</span><span class="op">(</span><span class="nam">counterpart_aml_dicts</span><span class="op">=</span><span class="nam">counterpart_aml_dicts</span><span class="op">,</span> <span class="nam">payment_aml_rec</span><span class="op">=</span><span class="nam">payment_aml_rec</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t731" class="mis show_mis"><span class="n"><a href="#t731">731</a></span><span class="t">            <span class="key">return</span> <span class="nam">counterpart</span>&nbsp;</span><span class="r"></span></p>
    <p id="t732" class="mis show_mis"><span class="n"><a href="#t732">732</a></span><span class="t">        <span class="key">except</span> <span class="nam">UserError</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t733" class="pln"><span class="n"><a href="#t733">733</a></span><span class="t">            <span class="com"># A configuration / business logic error that makes it impossible to auto-reconcile should not be raised</span>&nbsp;</span><span class="r"></span></p>
    <p id="t734" class="pln"><span class="n"><a href="#t734">734</a></span><span class="t">            <span class="com"># since automatic reconciliation is just an amenity and the user will get the same exception when manually</span>&nbsp;</span><span class="r"></span></p>
    <p id="t735" class="pln"><span class="n"><a href="#t735">735</a></span><span class="t">            <span class="com"># reconciling. Other types of exception are (hopefully) programmation errors and should cause a stacktrace.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t736" class="mis show_mis"><span class="n"><a href="#t736">736</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">invalidate_cache</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t737" class="mis show_mis"><span class="n"><a href="#t737">737</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move'</span><span class="op">]</span><span class="op">.</span><span class="nam">invalidate_cache</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t738" class="mis show_mis"><span class="n"><a href="#t738">738</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span><span class="op">.</span><span class="nam">invalidate_cache</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t739" class="mis show_mis"><span class="n"><a href="#t739">739</a></span><span class="t">            <span class="key">return</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t740" class="pln"><span class="n"><a href="#t740">740</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t741" class="run"><span class="n"><a href="#t741">741</a></span><span class="t">    <span class="key">def</span> <span class="nam">_prepare_reconciliation_move</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">move_ref</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t742" class="pln"><span class="n"><a href="#t742">742</a></span><span class="t">        <span class="str">""" Prepare the dict of values to create the move from a statement line. This method may be overridden to adapt domain logic</span>&nbsp;</span><span class="r"></span></p>
    <p id="t743" class="pln"><span class="n"><a href="#t743">743</a></span><span class="t"><span class="str">            through model inheritance (make sure to call super() to establish a clean extension chain).</span>&nbsp;</span><span class="r"></span></p>
    <p id="t744" class="pln"><span class="n"><a href="#t744">744</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t745" class="pln"><span class="n"><a href="#t745">745</a></span><span class="t"><span class="str">           :param char move_ref: will be used as the reference of the generated account move</span>&nbsp;</span><span class="r"></span></p>
    <p id="t746" class="pln"><span class="n"><a href="#t746">746</a></span><span class="t"><span class="str">           :return: dict of value to create() the account.move</span>&nbsp;</span><span class="r"></span></p>
    <p id="t747" class="pln"><span class="n"><a href="#t747">747</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t748" class="mis show_mis"><span class="n"><a href="#t748">748</a></span><span class="t">        <span class="nam">ref</span> <span class="op">=</span> <span class="nam">move_ref</span> <span class="key">or</span> <span class="str">''</span>&nbsp;</span><span class="r"></span></p>
    <p id="t749" class="mis show_mis"><span class="n"><a href="#t749">749</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ref</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t750" class="mis show_mis"><span class="n"><a href="#t750">750</a></span><span class="t">            <span class="nam">ref</span> <span class="op">=</span> <span class="nam">move_ref</span> <span class="op">+</span> <span class="str">' - '</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ref</span> <span class="key">if</span> <span class="nam">move_ref</span> <span class="key">else</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ref</span>&nbsp;</span><span class="r"></span></p>
    <p id="t751" class="mis show_mis"><span class="n"><a href="#t751">751</a></span><span class="t">        <span class="nam">data</span> <span class="op">=</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t752" class="pln"><span class="n"><a href="#t752">752</a></span><span class="t">            <span class="str">'statement_line_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t753" class="pln"><span class="n"><a href="#t753">753</a></span><span class="t">            <span class="str">'journal_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">statement_id</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t754" class="pln"><span class="n"><a href="#t754">754</a></span><span class="t">            <span class="str">'date'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">date</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t755" class="pln"><span class="n"><a href="#t755">755</a></span><span class="t">            <span class="str">'ref'</span><span class="op">:</span> <span class="nam">ref</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t756" class="pln"><span class="n"><a href="#t756">756</a></span><span class="t">        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t757" class="mis show_mis"><span class="n"><a href="#t757">757</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">move_name</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t758" class="mis show_mis"><span class="n"><a href="#t758">758</a></span><span class="t">            <span class="nam">data</span><span class="op">.</span><span class="nam">update</span><span class="op">(</span><span class="nam">name</span><span class="op">=</span><span class="nam">self</span><span class="op">.</span><span class="nam">move_name</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t759" class="mis show_mis"><span class="n"><a href="#t759">759</a></span><span class="t">        <span class="key">return</span> <span class="nam">data</span>&nbsp;</span><span class="r"></span></p>
    <p id="t760" class="pln"><span class="n"><a href="#t760">760</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t761" class="run"><span class="n"><a href="#t761">761</a></span><span class="t">    <span class="key">def</span> <span class="nam">_prepare_reconciliation_move_line</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">move</span><span class="op">,</span> <span class="nam">amount</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t762" class="pln"><span class="n"><a href="#t762">762</a></span><span class="t">        <span class="str">""" Prepare the dict of values to balance the move.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t763" class="pln"><span class="n"><a href="#t763">763</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t764" class="pln"><span class="n"><a href="#t764">764</a></span><span class="t"><span class="str">            :param recordset move: the account.move to link the move line</span>&nbsp;</span><span class="r"></span></p>
    <p id="t765" class="pln"><span class="n"><a href="#t765">765</a></span><span class="t"><span class="str">            :param float amount: the amount of transaction that wasn't already reconciled</span>&nbsp;</span><span class="r"></span></p>
    <p id="t766" class="pln"><span class="n"><a href="#t766">766</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t767" class="mis show_mis"><span class="n"><a href="#t767">767</a></span><span class="t">        <span class="nam">company_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t768" class="mis show_mis"><span class="n"><a href="#t768">768</a></span><span class="t">        <span class="nam">statement_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">company_currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t769" class="mis show_mis"><span class="n"><a href="#t769">769</a></span><span class="t">        <span class="nam">st_line_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">statement_currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t770" class="mis show_mis"><span class="n"><a href="#t770">770</a></span><span class="t">        <span class="nam">amount_currency</span> <span class="op">=</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t771" class="mis show_mis"><span class="n"><a href="#t771">771</a></span><span class="t">        <span class="nam">st_line_currency_rate</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">and</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">amount_currency</span> <span class="op">/</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount</span><span class="op">)</span> <span class="key">or</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t772" class="pln"><span class="n"><a href="#t772">772</a></span><span class="t">        <span class="com"># We have several use case here to compure the currency and amount currency of counterpart line to balance the move:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t773" class="mis show_mis"><span class="n"><a href="#t773">773</a></span><span class="t">        <span class="key">if</span> <span class="nam">st_line_currency</span> <span class="op">!=</span> <span class="nam">company_currency</span> <span class="key">and</span> <span class="nam">st_line_currency</span> <span class="op">==</span> <span class="nam">statement_currency</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t774" class="pln"><span class="n"><a href="#t774">774</a></span><span class="t">            <span class="com"># company in currency A, statement in currency B and transaction in currency B</span>&nbsp;</span><span class="r"></span></p>
    <p id="t775" class="pln"><span class="n"><a href="#t775">775</a></span><span class="t">            <span class="com"># counterpart line must have currency B and correct amount is inverse of already existing lines</span>&nbsp;</span><span class="r"></span></p>
    <p id="t776" class="mis show_mis"><span class="n"><a href="#t776">776</a></span><span class="t">            <span class="nam">amount_currency</span> <span class="op">=</span> <span class="op">-</span><span class="nam">sum</span><span class="op">(</span><span class="op">[</span><span class="nam">x</span><span class="op">.</span><span class="nam">amount_currency</span> <span class="key">for</span> <span class="nam">x</span> <span class="key">in</span> <span class="nam">move</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t777" class="mis show_mis"><span class="n"><a href="#t777">777</a></span><span class="t">        <span class="key">elif</span> <span class="nam">st_line_currency</span> <span class="op">!=</span> <span class="nam">company_currency</span> <span class="key">and</span> <span class="nam">statement_currency</span> <span class="op">==</span> <span class="nam">company_currency</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t778" class="pln"><span class="n"><a href="#t778">778</a></span><span class="t">            <span class="com"># company in currency A, statement in currency A and transaction in currency B</span>&nbsp;</span><span class="r"></span></p>
    <p id="t779" class="pln"><span class="n"><a href="#t779">779</a></span><span class="t">            <span class="com"># counterpart line must have currency B and correct amount is inverse of already existing lines</span>&nbsp;</span><span class="r"></span></p>
    <p id="t780" class="mis show_mis"><span class="n"><a href="#t780">780</a></span><span class="t">            <span class="nam">amount_currency</span> <span class="op">=</span> <span class="op">-</span><span class="nam">sum</span><span class="op">(</span><span class="op">[</span><span class="nam">x</span><span class="op">.</span><span class="nam">amount_currency</span> <span class="key">for</span> <span class="nam">x</span> <span class="key">in</span> <span class="nam">move</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t781" class="mis show_mis"><span class="n"><a href="#t781">781</a></span><span class="t">        <span class="key">elif</span> <span class="nam">st_line_currency</span> <span class="op">!=</span> <span class="nam">company_currency</span> <span class="key">and</span> <span class="nam">st_line_currency</span> <span class="op">!=</span> <span class="nam">statement_currency</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t782" class="pln"><span class="n"><a href="#t782">782</a></span><span class="t">            <span class="com"># company in currency A, statement in currency B and transaction in currency C</span>&nbsp;</span><span class="r"></span></p>
    <p id="t783" class="pln"><span class="n"><a href="#t783">783</a></span><span class="t">            <span class="com"># counterpart line must have currency B and use rate between B and C to compute correct amount</span>&nbsp;</span><span class="r"></span></p>
    <p id="t784" class="mis show_mis"><span class="n"><a href="#t784">784</a></span><span class="t">            <span class="nam">amount_currency</span> <span class="op">=</span> <span class="op">-</span><span class="nam">sum</span><span class="op">(</span><span class="op">[</span><span class="nam">x</span><span class="op">.</span><span class="nam">amount_currency</span> <span class="key">for</span> <span class="nam">x</span> <span class="key">in</span> <span class="nam">move</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="nam">st_line_currency_rate</span>&nbsp;</span><span class="r"></span></p>
    <p id="t785" class="mis show_mis"><span class="n"><a href="#t785">785</a></span><span class="t">        <span class="key">elif</span> <span class="nam">st_line_currency</span> <span class="op">==</span> <span class="nam">company_currency</span> <span class="key">and</span> <span class="nam">statement_currency</span> <span class="op">!=</span> <span class="nam">company_currency</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t786" class="pln"><span class="n"><a href="#t786">786</a></span><span class="t">            <span class="com"># company in currency A, statement in currency B and transaction in currency A</span>&nbsp;</span><span class="r"></span></p>
    <p id="t787" class="pln"><span class="n"><a href="#t787">787</a></span><span class="t">            <span class="com"># counterpart line must have currency B and amount is computed using the rate between A and B</span>&nbsp;</span><span class="r"></span></p>
    <p id="t788" class="mis show_mis"><span class="n"><a href="#t788">788</a></span><span class="t">            <span class="nam">amount_currency</span> <span class="op">=</span> <span class="nam">amount</span><span class="op">/</span><span class="nam">st_line_currency_rate</span>&nbsp;</span><span class="r"></span></p>
    <p id="t789" class="pln"><span class="n"><a href="#t789">789</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t790" class="pln"><span class="n"><a href="#t790">790</a></span><span class="t">        <span class="com"># last case is company in currency A, statement in currency A and transaction in currency A</span>&nbsp;</span><span class="r"></span></p>
    <p id="t791" class="pln"><span class="n"><a href="#t791">791</a></span><span class="t">        <span class="com"># and in this case counterpart line does not need any second currency nor amount_currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t792" class="pln"><span class="n"><a href="#t792">792</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t793" class="mis show_mis"><span class="n"><a href="#t793">793</a></span><span class="t">        <span class="key">return</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t794" class="pln"><span class="n"><a href="#t794">794</a></span><span class="t">            <span class="str">'name'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t795" class="pln"><span class="n"><a href="#t795">795</a></span><span class="t">            <span class="str">'move_id'</span><span class="op">:</span> <span class="nam">move</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t796" class="pln"><span class="n"><a href="#t796">796</a></span><span class="t">            <span class="str">'partner_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t797" class="pln"><span class="n"><a href="#t797">797</a></span><span class="t">            <span class="str">'account_id'</span><span class="op">:</span> <span class="nam">amount</span> <span class="op">>=</span> <span class="num">0</span> <span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t798" class="pln"><span class="n"><a href="#t798">798</a></span><span class="t">                <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">statement_id</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_credit_account_id</span><span class="op">.</span><span class="nam">id</span> <span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t799" class="pln"><span class="n"><a href="#t799">799</a></span><span class="t">                <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">statement_id</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">default_debit_account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t800" class="pln"><span class="n"><a href="#t800">800</a></span><span class="t">            <span class="str">'credit'</span><span class="op">:</span> <span class="nam">amount</span> <span class="op">&lt;</span> <span class="num">0</span> <span class="key">and</span> <span class="op">-</span><span class="nam">amount</span> <span class="key">or</span> <span class="num">0.0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t801" class="pln"><span class="n"><a href="#t801">801</a></span><span class="t">            <span class="str">'debit'</span><span class="op">:</span> <span class="nam">amount</span> <span class="op">></span> <span class="num">0</span> <span class="key">and</span> <span class="nam">amount</span> <span class="key">or</span> <span class="num">0.0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t802" class="pln"><span class="n"><a href="#t802">802</a></span><span class="t">            <span class="str">'statement_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">statement_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t803" class="pln"><span class="n"><a href="#t803">803</a></span><span class="t">            <span class="str">'currency_id'</span><span class="op">:</span> <span class="nam">statement_currency</span> <span class="op">!=</span> <span class="nam">company_currency</span> <span class="key">and</span> <span class="nam">statement_currency</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="op">(</span><span class="nam">st_line_currency</span> <span class="op">!=</span> <span class="nam">company_currency</span> <span class="key">and</span> <span class="nam">st_line_currency</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">False</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t804" class="pln"><span class="n"><a href="#t804">804</a></span><span class="t">            <span class="str">'amount_currency'</span><span class="op">:</span> <span class="nam">amount_currency</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t805" class="pln"><span class="n"><a href="#t805">805</a></span><span class="t">        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t806" class="pln"><span class="n"><a href="#t806">806</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t807" class="run"><span class="n"><a href="#t807">807</a></span><span class="t">    <span class="op">@</span><span class="nam">api</span><span class="op">.</span><span class="nam">multi</span>&nbsp;</span><span class="r"></span></p>
    <p id="t808" class="pln"><span class="n"><a href="#t808">808</a></span><span class="t">    <span class="key">def</span> <span class="nam">process_reconciliations</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">data</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t809" class="pln"><span class="n"><a href="#t809">809</a></span><span class="t">        <span class="str">""" Handles data sent from the bank statement reconciliation widget (and can otherwise serve as an old-API bridge)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t810" class="pln"><span class="n"><a href="#t810">810</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t811" class="pln"><span class="n"><a href="#t811">811</a></span><span class="t"><span class="str">            :param list of dicts data: must contains the keys 'counterpart_aml_dicts', 'payment_aml_ids' and 'new_aml_dicts',</span>&nbsp;</span><span class="r"></span></p>
    <p id="t812" class="pln"><span class="n"><a href="#t812">812</a></span><span class="t"><span class="str">                whose value is the same as described in process_reconciliation except that ids are used instead of recordsets.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t813" class="pln"><span class="n"><a href="#t813">813</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t814" class="mis show_mis"><span class="n"><a href="#t814">814</a></span><span class="t">        <span class="nam">AccountMoveLine</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t815" class="mis show_mis"><span class="n"><a href="#t815">815</a></span><span class="t">        <span class="key">for</span> <span class="nam">st_line</span><span class="op">,</span> <span class="nam">datum</span> <span class="key">in</span> <span class="nam">zip</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">data</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t816" class="mis show_mis"><span class="n"><a href="#t816">816</a></span><span class="t">            <span class="nam">payment_aml_rec</span> <span class="op">=</span> <span class="nam">AccountMoveLine</span><span class="op">.</span><span class="nam">browse</span><span class="op">(</span><span class="nam">datum</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'payment_aml_ids'</span><span class="op">,</span> <span class="op">[</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t817" class="mis show_mis"><span class="n"><a href="#t817">817</a></span><span class="t">            <span class="key">for</span> <span class="nam">aml_dict</span> <span class="key">in</span> <span class="nam">datum</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'counterpart_aml_dicts'</span><span class="op">,</span> <span class="op">[</span><span class="op">]</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t818" class="mis show_mis"><span class="n"><a href="#t818">818</a></span><span class="t">                <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'move_line'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">AccountMoveLine</span><span class="op">.</span><span class="nam">browse</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">[</span><span class="str">'counterpart_aml_id'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t819" class="mis show_mis"><span class="n"><a href="#t819">819</a></span><span class="t">                <span class="key">del</span> <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'counterpart_aml_id'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t820" class="mis show_mis"><span class="n"><a href="#t820">820</a></span><span class="t">            <span class="nam">st_line</span><span class="op">.</span><span class="nam">process_reconciliation</span><span class="op">(</span><span class="nam">datum</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'counterpart_aml_dicts'</span><span class="op">,</span> <span class="op">[</span><span class="op">]</span><span class="op">)</span><span class="op">,</span> <span class="nam">payment_aml_rec</span><span class="op">,</span> <span class="nam">datum</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'new_aml_dicts'</span><span class="op">,</span> <span class="op">[</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t821" class="pln"><span class="n"><a href="#t821">821</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t822" class="run"><span class="n"><a href="#t822">822</a></span><span class="t">    <span class="key">def</span> <span class="nam">fast_counterpart_creation</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t823" class="mis show_mis"><span class="n"><a href="#t823">823</a></span><span class="t">        <span class="key">for</span> <span class="nam">st_line</span> <span class="key">in</span> <span class="nam">self</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t824" class="pln"><span class="n"><a href="#t824">824</a></span><span class="t">            <span class="com"># Technical functionality to automatically reconcile by creating a new move line</span>&nbsp;</span><span class="r"></span></p>
    <p id="t825" class="mis show_mis"><span class="n"><a href="#t825">825</a></span><span class="t">            <span class="nam">vals</span> <span class="op">=</span> <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t826" class="pln"><span class="n"><a href="#t826">826</a></span><span class="t">                <span class="str">'name'</span><span class="op">:</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t827" class="pln"><span class="n"><a href="#t827">827</a></span><span class="t">                <span class="str">'debit'</span><span class="op">:</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">amount</span> <span class="op">&lt;</span> <span class="num">0</span> <span class="key">and</span> <span class="op">-</span><span class="nam">st_line</span><span class="op">.</span><span class="nam">amount</span> <span class="key">or</span> <span class="num">0.0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t828" class="pln"><span class="n"><a href="#t828">828</a></span><span class="t">                <span class="str">'credit'</span><span class="op">:</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">amount</span> <span class="op">></span> <span class="num">0</span> <span class="key">and</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">amount</span> <span class="key">or</span> <span class="num">0.0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t829" class="pln"><span class="n"><a href="#t829">829</a></span><span class="t">                <span class="str">'account_id'</span><span class="op">:</span> <span class="nam">st_line</span><span class="op">.</span><span class="nam">account_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t830" class="pln"><span class="n"><a href="#t830">830</a></span><span class="t">            <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t831" class="mis show_mis"><span class="n"><a href="#t831">831</a></span><span class="t">            <span class="nam">st_line</span><span class="op">.</span><span class="nam">process_reconciliation</span><span class="op">(</span><span class="nam">new_aml_dicts</span><span class="op">=</span><span class="op">[</span><span class="nam">vals</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t832" class="pln"><span class="n"><a href="#t832">832</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t833" class="run"><span class="n"><a href="#t833">833</a></span><span class="t">    <span class="key">def</span> <span class="nam">_get_communication</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">payment_method_id</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t834" class="mis show_mis"><span class="n"><a href="#t834">834</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">name</span> <span class="key">or</span> <span class="str">''</span>&nbsp;</span><span class="r"></span></p>
    <p id="t835" class="pln"><span class="n"><a href="#t835">835</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t836" class="run"><span class="n"><a href="#t836">836</a></span><span class="t">    <span class="key">def</span> <span class="nam">process_reconciliation</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">counterpart_aml_dicts</span><span class="op">=</span><span class="nam">None</span><span class="op">,</span> <span class="nam">payment_aml_rec</span><span class="op">=</span><span class="nam">None</span><span class="op">,</span> <span class="nam">new_aml_dicts</span><span class="op">=</span><span class="nam">None</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t837" class="pln"><span class="n"><a href="#t837">837</a></span><span class="t">        <span class="str">""" Match statement lines with existing payments (eg. checks) and/or payables/receivables (eg. invoices and refunds) and/or new move lines (eg. write-offs).</span>&nbsp;</span><span class="r"></span></p>
    <p id="t838" class="pln"><span class="n"><a href="#t838">838</a></span><span class="t"><span class="str">            If any new journal item needs to be created (via new_aml_dicts or counterpart_aml_dicts), a new journal entry will be created and will contain those</span>&nbsp;</span><span class="r"></span></p>
    <p id="t839" class="pln"><span class="n"><a href="#t839">839</a></span><span class="t"><span class="str">            items, as well as a journal item for the bank statement line.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t840" class="pln"><span class="n"><a href="#t840">840</a></span><span class="t"><span class="str">            Finally, mark the statement line as reconciled by putting the matched moves ids in the column journal_entry_ids.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t841" class="pln"><span class="n"><a href="#t841">841</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t842" class="pln"><span class="n"><a href="#t842">842</a></span><span class="t"><span class="str">            :param self: browse collection of records that are supposed to have no accounting entries already linked.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t843" class="pln"><span class="n"><a href="#t843">843</a></span><span class="t"><span class="str">            :param (list of dicts) counterpart_aml_dicts: move lines to create to reconcile with existing payables/receivables.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t844" class="pln"><span class="n"><a href="#t844">844</a></span><span class="t"><span class="str">                The expected keys are :</span>&nbsp;</span><span class="r"></span></p>
    <p id="t845" class="pln"><span class="n"><a href="#t845">845</a></span><span class="t"><span class="str">                - 'name'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t846" class="pln"><span class="n"><a href="#t846">846</a></span><span class="t"><span class="str">                - 'debit'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t847" class="pln"><span class="n"><a href="#t847">847</a></span><span class="t"><span class="str">                - 'credit'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t848" class="pln"><span class="n"><a href="#t848">848</a></span><span class="t"><span class="str">                - 'move_line'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t849" class="pln"><span class="n"><a href="#t849">849</a></span><span class="t"><span class="str">                    # The move line to reconcile (partially if specified debit/credit is lower than move line's credit/debit)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t850" class="pln"><span class="n"><a href="#t850">850</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t851" class="pln"><span class="n"><a href="#t851">851</a></span><span class="t"><span class="str">            :param (list of recordsets) payment_aml_rec: recordset move lines representing existing payments (which are already fully reconciled)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t852" class="pln"><span class="n"><a href="#t852">852</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t853" class="pln"><span class="n"><a href="#t853">853</a></span><span class="t"><span class="str">            :param (list of dicts) new_aml_dicts: move lines to create. The expected keys are :</span>&nbsp;</span><span class="r"></span></p>
    <p id="t854" class="pln"><span class="n"><a href="#t854">854</a></span><span class="t"><span class="str">                - 'name'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t855" class="pln"><span class="n"><a href="#t855">855</a></span><span class="t"><span class="str">                - 'debit'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t856" class="pln"><span class="n"><a href="#t856">856</a></span><span class="t"><span class="str">                - 'credit'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t857" class="pln"><span class="n"><a href="#t857">857</a></span><span class="t"><span class="str">                - 'account_id'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t858" class="pln"><span class="n"><a href="#t858">858</a></span><span class="t"><span class="str">                - (optional) 'tax_ids'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t859" class="pln"><span class="n"><a href="#t859">859</a></span><span class="t"><span class="str">                - (optional) Other account.move.line fields like analytic_account_id or analytics_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t860" class="pln"><span class="n"><a href="#t860">860</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t861" class="pln"><span class="n"><a href="#t861">861</a></span><span class="t"><span class="str">            :returns: The journal entries with which the transaction was matched. If there was at least an entry in counterpart_aml_dicts or new_aml_dicts, this list contains</span>&nbsp;</span><span class="r"></span></p>
    <p id="t862" class="pln"><span class="n"><a href="#t862">862</a></span><span class="t"><span class="str">                the move created by the reconciliation, containing entries for the statement.line (1), the counterpart move lines (0..*) and the new move lines (0..*).</span>&nbsp;</span><span class="r"></span></p>
    <p id="t863" class="pln"><span class="n"><a href="#t863">863</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t864" class="mis show_mis"><span class="n"><a href="#t864">864</a></span><span class="t">        <span class="nam">counterpart_aml_dicts</span> <span class="op">=</span> <span class="nam">counterpart_aml_dicts</span> <span class="key">or</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t865" class="mis show_mis"><span class="n"><a href="#t865">865</a></span><span class="t">        <span class="nam">payment_aml_rec</span> <span class="op">=</span> <span class="nam">payment_aml_rec</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t866" class="mis show_mis"><span class="n"><a href="#t866">866</a></span><span class="t">        <span class="nam">new_aml_dicts</span> <span class="op">=</span> <span class="nam">new_aml_dicts</span> <span class="key">or</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t867" class="pln"><span class="n"><a href="#t867">867</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t868" class="mis show_mis"><span class="n"><a href="#t868">868</a></span><span class="t">        <span class="nam">aml_obj</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t869" class="pln"><span class="n"><a href="#t869">869</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t870" class="mis show_mis"><span class="n"><a href="#t870">870</a></span><span class="t">        <span class="nam">company_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t871" class="mis show_mis"><span class="n"><a href="#t871">871</a></span><span class="t">        <span class="nam">statement_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">company_currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t872" class="mis show_mis"><span class="n"><a href="#t872">872</a></span><span class="t">        <span class="nam">st_line_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">statement_currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t873" class="pln"><span class="n"><a href="#t873">873</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t874" class="mis show_mis"><span class="n"><a href="#t874">874</a></span><span class="t">        <span class="nam">counterpart_moves</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t875" class="pln"><span class="n"><a href="#t875">875</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t876" class="pln"><span class="n"><a href="#t876">876</a></span><span class="t">        <span class="com"># Check and prepare received data</span>&nbsp;</span><span class="r"></span></p>
    <p id="t877" class="mis show_mis"><span class="n"><a href="#t877">877</a></span><span class="t">        <span class="key">if</span> <span class="nam">any</span><span class="op">(</span><span class="nam">rec</span><span class="op">.</span><span class="nam">statement_id</span> <span class="key">for</span> <span class="nam">rec</span> <span class="key">in</span> <span class="nam">payment_aml_rec</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t878" class="mis show_mis"><span class="n"><a href="#t878">878</a></span><span class="t">            <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'A selected move line was already reconciled.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t879" class="mis show_mis"><span class="n"><a href="#t879">879</a></span><span class="t">        <span class="key">for</span> <span class="nam">aml_dict</span> <span class="key">in</span> <span class="nam">counterpart_aml_dicts</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t880" class="mis show_mis"><span class="n"><a href="#t880">880</a></span><span class="t">            <span class="key">if</span> <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'move_line'</span><span class="op">]</span><span class="op">.</span><span class="nam">reconciled</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t881" class="mis show_mis"><span class="n"><a href="#t881">881</a></span><span class="t">                <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'A selected move line was already reconciled.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t882" class="mis show_mis"><span class="n"><a href="#t882">882</a></span><span class="t">            <span class="key">if</span> <span class="nam">isinstance</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">[</span><span class="str">'move_line'</span><span class="op">]</span><span class="op">,</span> <span class="op">(</span><span class="nam">int</span><span class="op">,</span> <span class="nam">long</span><span class="op">)</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t883" class="mis show_mis"><span class="n"><a href="#t883">883</a></span><span class="t">                <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'move_line'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">aml_obj</span><span class="op">.</span><span class="nam">browse</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">[</span><span class="str">'move_line'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t884" class="mis show_mis"><span class="n"><a href="#t884">884</a></span><span class="t">        <span class="key">for</span> <span class="nam">aml_dict</span> <span class="key">in</span> <span class="op">(</span><span class="nam">counterpart_aml_dicts</span> <span class="op">+</span> <span class="nam">new_aml_dicts</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t885" class="mis show_mis"><span class="n"><a href="#t885">885</a></span><span class="t">            <span class="key">if</span> <span class="nam">aml_dict</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'tax_ids'</span><span class="op">)</span> <span class="key">and</span> <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'tax_ids'</span><span class="op">]</span> <span class="key">and</span> <span class="nam">isinstance</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">[</span><span class="str">'tax_ids'</span><span class="op">]</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span> <span class="op">(</span><span class="nam">int</span><span class="op">,</span> <span class="nam">long</span><span class="op">)</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t886" class="pln"><span class="n"><a href="#t886">886</a></span><span class="t">                <span class="com"># Transform the value in the format required for One2many and Many2many fields</span>&nbsp;</span><span class="r"></span></p>
    <p id="t887" class="mis show_mis"><span class="n"><a href="#t887">887</a></span><span class="t">                <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'tax_ids'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">map</span><span class="op">(</span><span class="key">lambda</span> <span class="nam">id</span><span class="op">:</span> <span class="op">(</span><span class="num">4</span><span class="op">,</span> <span class="nam">id</span><span class="op">,</span> <span class="nam">None</span><span class="op">)</span><span class="op">,</span> <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'tax_ids'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t888" class="mis show_mis"><span class="n"><a href="#t888">888</a></span><span class="t">        <span class="key">if</span> <span class="nam">any</span><span class="op">(</span><span class="nam">line</span><span class="op">.</span><span class="nam">journal_entry_ids</span> <span class="key">for</span> <span class="nam">line</span> <span class="key">in</span> <span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t889" class="mis show_mis"><span class="n"><a href="#t889">889</a></span><span class="t">            <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'A selected statement line was already reconciled with an account move.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t890" class="pln"><span class="n"><a href="#t890">890</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t891" class="pln"><span class="n"><a href="#t891">891</a></span><span class="t">        <span class="com"># Fully reconciled moves are just linked to the bank statement</span>&nbsp;</span><span class="r"></span></p>
    <p id="t892" class="mis show_mis"><span class="n"><a href="#t892">892</a></span><span class="t">        <span class="nam">total</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount</span>&nbsp;</span><span class="r"></span></p>
    <p id="t893" class="mis show_mis"><span class="n"><a href="#t893">893</a></span><span class="t">        <span class="key">for</span> <span class="nam">aml_rec</span> <span class="key">in</span> <span class="nam">payment_aml_rec</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t894" class="mis show_mis"><span class="n"><a href="#t894">894</a></span><span class="t">            <span class="nam">total</span> <span class="op">-=</span> <span class="nam">aml_rec</span><span class="op">.</span><span class="nam">debit</span><span class="op">-</span><span class="nam">aml_rec</span><span class="op">.</span><span class="nam">credit</span>&nbsp;</span><span class="r"></span></p>
    <p id="t895" class="mis show_mis"><span class="n"><a href="#t895">895</a></span><span class="t">            <span class="nam">aml_rec</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">check_move_validity</span><span class="op">=</span><span class="nam">False</span><span class="op">)</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'statement_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">statement_id</span><span class="op">.</span><span class="nam">id</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t896" class="mis show_mis"><span class="n"><a href="#t896">896</a></span><span class="t">            <span class="nam">aml_rec</span><span class="op">.</span><span class="nam">move_id</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'statement_line_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">id</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t897" class="mis show_mis"><span class="n"><a href="#t897">897</a></span><span class="t">            <span class="nam">counterpart_moves</span> <span class="op">=</span> <span class="op">(</span><span class="nam">counterpart_moves</span> <span class="op">|</span> <span class="nam">aml_rec</span><span class="op">.</span><span class="nam">move_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t898" class="pln"><span class="n"><a href="#t898">898</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t899" class="pln"><span class="n"><a href="#t899">899</a></span><span class="t">        <span class="com"># Create move line(s). Either matching an existing journal entry (eg. invoice), in which</span>&nbsp;</span><span class="r"></span></p>
    <p id="t900" class="pln"><span class="n"><a href="#t900">900</a></span><span class="t">        <span class="com"># case we reconcile the existing and the new move lines together, or being a write-off.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t901" class="mis show_mis"><span class="n"><a href="#t901">901</a></span><span class="t">        <span class="key">if</span> <span class="nam">counterpart_aml_dicts</span> <span class="key">or</span> <span class="nam">new_aml_dicts</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t902" class="mis show_mis"><span class="n"><a href="#t902">902</a></span><span class="t">            <span class="nam">st_line_currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">statement_currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t903" class="mis show_mis"><span class="n"><a href="#t903">903</a></span><span class="t">            <span class="nam">st_line_currency_rate</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">and</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">amount_currency</span> <span class="op">/</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount</span><span class="op">)</span> <span class="key">or</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t904" class="pln"><span class="n"><a href="#t904">904</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t905" class="pln"><span class="n"><a href="#t905">905</a></span><span class="t">            <span class="com"># Create the move</span>&nbsp;</span><span class="r"></span></p>
    <p id="t906" class="mis show_mis"><span class="n"><a href="#t906">906</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">sequence</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">statement_id</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">.</span><span class="nam">ids</span><span class="op">.</span><span class="nam">index</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span> <span class="op">+</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t907" class="mis show_mis"><span class="n"><a href="#t907">907</a></span><span class="t">            <span class="nam">move_vals</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_prepare_reconciliation_move</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">statement_id</span><span class="op">.</span><span class="nam">name</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t908" class="mis show_mis"><span class="n"><a href="#t908">908</a></span><span class="t">            <span class="nam">move</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move'</span><span class="op">]</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="nam">move_vals</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t909" class="mis show_mis"><span class="n"><a href="#t909">909</a></span><span class="t">            <span class="nam">counterpart_moves</span> <span class="op">=</span> <span class="op">(</span><span class="nam">counterpart_moves</span> <span class="op">|</span> <span class="nam">move</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t910" class="pln"><span class="n"><a href="#t910">910</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t911" class="pln"><span class="n"><a href="#t911">911</a></span><span class="t">            <span class="com"># Create The payment</span>&nbsp;</span><span class="r"></span></p>
    <p id="t912" class="mis show_mis"><span class="n"><a href="#t912">912</a></span><span class="t">            <span class="nam">payment</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.payment'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t913" class="mis show_mis"><span class="n"><a href="#t913">913</a></span><span class="t">            <span class="key">if</span> <span class="nam">abs</span><span class="op">(</span><span class="nam">total</span><span class="op">)</span><span class="op">></span><span class="num">0.00001</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t914" class="mis show_mis"><span class="n"><a href="#t914">914</a></span><span class="t">                <span class="nam">partner_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t915" class="mis show_mis"><span class="n"><a href="#t915">915</a></span><span class="t">                <span class="nam">partner_type</span> <span class="op">=</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t916" class="mis show_mis"><span class="n"><a href="#t916">916</a></span><span class="t">                <span class="key">if</span> <span class="nam">partner_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t917" class="mis show_mis"><span class="n"><a href="#t917">917</a></span><span class="t">                    <span class="key">if</span> <span class="nam">total</span> <span class="op">&lt;</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t918" class="mis show_mis"><span class="n"><a href="#t918">918</a></span><span class="t">                        <span class="nam">partner_type</span> <span class="op">=</span> <span class="str">'supplier'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t919" class="pln"><span class="n"><a href="#t919">919</a></span><span class="t">                    <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t920" class="mis show_mis"><span class="n"><a href="#t920">920</a></span><span class="t">                        <span class="nam">partner_type</span> <span class="op">=</span> <span class="str">'customer'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t921" class="pln"><span class="n"><a href="#t921">921</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t922" class="mis show_mis"><span class="n"><a href="#t922">922</a></span><span class="t">                <span class="nam">payment_methods</span> <span class="op">=</span> <span class="op">(</span><span class="nam">total</span><span class="op">></span><span class="num">0</span><span class="op">)</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">inbound_payment_method_ids</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">outbound_payment_method_ids</span>&nbsp;</span><span class="r"></span></p>
    <p id="t923" class="mis show_mis"><span class="n"><a href="#t923">923</a></span><span class="t">                <span class="nam">currency</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">or</span> <span class="nam">self</span><span class="op">.</span><span class="nam">company_id</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t924" class="mis show_mis"><span class="n"><a href="#t924">924</a></span><span class="t">                <span class="nam">payment</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.payment'</span><span class="op">]</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p id="t925" class="pln"><span class="n"><a href="#t925">925</a></span><span class="t">                    <span class="str">'payment_method_id'</span><span class="op">:</span> <span class="nam">payment_methods</span> <span class="key">and</span> <span class="nam">payment_methods</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t926" class="pln"><span class="n"><a href="#t926">926</a></span><span class="t">                    <span class="str">'payment_type'</span><span class="op">:</span> <span class="nam">total</span> <span class="op">></span><span class="num">0</span> <span class="key">and</span> <span class="str">'inbound'</span> <span class="key">or</span> <span class="str">'outbound'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t927" class="pln"><span class="n"><a href="#t927">927</a></span><span class="t">                    <span class="str">'partner_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span> <span class="key">and</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t928" class="pln"><span class="n"><a href="#t928">928</a></span><span class="t">                    <span class="str">'partner_type'</span><span class="op">:</span> <span class="nam">partner_type</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t929" class="pln"><span class="n"><a href="#t929">929</a></span><span class="t">                    <span class="str">'journal_id'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">statement_id</span><span class="op">.</span><span class="nam">journal_id</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t930" class="pln"><span class="n"><a href="#t930">930</a></span><span class="t">                    <span class="str">'payment_date'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">date</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t931" class="pln"><span class="n"><a href="#t931">931</a></span><span class="t">                    <span class="str">'state'</span><span class="op">:</span> <span class="str">'reconciled'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t932" class="pln"><span class="n"><a href="#t932">932</a></span><span class="t">                    <span class="str">'currency_id'</span><span class="op">:</span> <span class="nam">currency</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t933" class="pln"><span class="n"><a href="#t933">933</a></span><span class="t">                    <span class="str">'amount'</span><span class="op">:</span> <span class="nam">abs</span><span class="op">(</span><span class="nam">total</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t934" class="pln"><span class="n"><a href="#t934">934</a></span><span class="t">                    <span class="str">'communication'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_communication</span><span class="op">(</span><span class="nam">payment_methods</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">if</span> <span class="nam">payment_methods</span> <span class="key">else</span> <span class="nam">False</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t935" class="pln"><span class="n"><a href="#t935">935</a></span><span class="t">                    <span class="str">'name'</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">statement_id</span><span class="op">.</span><span class="nam">name</span> <span class="key">or</span> <span class="nam">_</span><span class="op">(</span><span class="str">"Bank Statement %s"</span><span class="op">)</span> <span class="op">%</span>  <span class="nam">self</span><span class="op">.</span><span class="nam">date</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t936" class="pln"><span class="n"><a href="#t936">936</a></span><span class="t">                <span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t937" class="pln"><span class="n"><a href="#t937">937</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t938" class="pln"><span class="n"><a href="#t938">938</a></span><span class="t">            <span class="com"># Complete dicts to create both counterpart move lines and write-offs</span>&nbsp;</span><span class="r"></span></p>
    <p id="t939" class="mis show_mis"><span class="n"><a href="#t939">939</a></span><span class="t">            <span class="nam">to_create</span> <span class="op">=</span> <span class="op">(</span><span class="nam">counterpart_aml_dicts</span> <span class="op">+</span> <span class="nam">new_aml_dicts</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t940" class="mis show_mis"><span class="n"><a href="#t940">940</a></span><span class="t">            <span class="nam">ctx</span> <span class="op">=</span> <span class="nam">dict</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">_context</span><span class="op">,</span> <span class="nam">date</span><span class="op">=</span><span class="nam">self</span><span class="op">.</span><span class="nam">date</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t941" class="mis show_mis"><span class="n"><a href="#t941">941</a></span><span class="t">            <span class="key">for</span> <span class="nam">aml_dict</span> <span class="key">in</span> <span class="nam">to_create</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t942" class="mis show_mis"><span class="n"><a href="#t942">942</a></span><span class="t">                <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'move_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">move</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t943" class="mis show_mis"><span class="n"><a href="#t943">943</a></span><span class="t">                <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'partner_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t944" class="mis show_mis"><span class="n"><a href="#t944">944</a></span><span class="t">                <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'statement_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">statement_id</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t945" class="mis show_mis"><span class="n"><a href="#t945">945</a></span><span class="t">                <span class="key">if</span> <span class="nam">st_line_currency</span><span class="op">.</span><span class="nam">id</span> <span class="op">!=</span> <span class="nam">company_currency</span><span class="op">.</span><span class="nam">id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t946" class="mis show_mis"><span class="n"><a href="#t946">946</a></span><span class="t">                    <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'amount_currency'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'debit'</span><span class="op">]</span> <span class="op">-</span> <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'credit'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t947" class="mis show_mis"><span class="n"><a href="#t947">947</a></span><span class="t">                    <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'currency_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">st_line_currency</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t948" class="mis show_mis"><span class="n"><a href="#t948">948</a></span><span class="t">                    <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">and</span> <span class="nam">statement_currency</span><span class="op">.</span><span class="nam">id</span> <span class="op">==</span> <span class="nam">company_currency</span><span class="op">.</span><span class="nam">id</span> <span class="key">and</span> <span class="nam">st_line_currency_rate</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t949" class="pln"><span class="n"><a href="#t949">949</a></span><span class="t">                        <span class="com"># Statement is in company currency but the transaction is in foreign currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t950" class="mis show_mis"><span class="n"><a href="#t950">950</a></span><span class="t">                        <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'debit'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">company_currency</span><span class="op">.</span><span class="nam">round</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">[</span><span class="str">'debit'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">st_line_currency_rate</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t951" class="mis show_mis"><span class="n"><a href="#t951">951</a></span><span class="t">                        <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'credit'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">company_currency</span><span class="op">.</span><span class="nam">round</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">[</span><span class="str">'credit'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">st_line_currency_rate</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t952" class="mis show_mis"><span class="n"><a href="#t952">952</a></span><span class="t">                    <span class="key">elif</span> <span class="nam">self</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">and</span> <span class="nam">st_line_currency_rate</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t953" class="pln"><span class="n"><a href="#t953">953</a></span><span class="t">                        <span class="com"># Statement is in foreign currency and the transaction is in another one</span>&nbsp;</span><span class="r"></span></p>
    <p id="t954" class="mis show_mis"><span class="n"><a href="#t954">954</a></span><span class="t">                        <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'debit'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">statement_currency</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">ctx</span><span class="op">)</span><span class="op">.</span><span class="nam">compute</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">[</span><span class="str">'debit'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">st_line_currency_rate</span><span class="op">,</span> <span class="nam">company_currency</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t955" class="mis show_mis"><span class="n"><a href="#t955">955</a></span><span class="t">                        <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'credit'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">statement_currency</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">ctx</span><span class="op">)</span><span class="op">.</span><span class="nam">compute</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">[</span><span class="str">'credit'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">st_line_currency_rate</span><span class="op">,</span> <span class="nam">company_currency</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t956" class="pln"><span class="n"><a href="#t956">956</a></span><span class="t">                    <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t957" class="pln"><span class="n"><a href="#t957">957</a></span><span class="t">                        <span class="com"># Statement is in foreign currency and no extra currency is given for the transaction</span>&nbsp;</span><span class="r"></span></p>
    <p id="t958" class="mis show_mis"><span class="n"><a href="#t958">958</a></span><span class="t">                        <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'debit'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">st_line_currency</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">ctx</span><span class="op">)</span><span class="op">.</span><span class="nam">compute</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">[</span><span class="str">'debit'</span><span class="op">]</span><span class="op">,</span> <span class="nam">company_currency</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t959" class="mis show_mis"><span class="n"><a href="#t959">959</a></span><span class="t">                        <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'credit'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">st_line_currency</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">ctx</span><span class="op">)</span><span class="op">.</span><span class="nam">compute</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">[</span><span class="str">'credit'</span><span class="op">]</span><span class="op">,</span> <span class="nam">company_currency</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t960" class="mis show_mis"><span class="n"><a href="#t960">960</a></span><span class="t">                <span class="key">elif</span> <span class="nam">statement_currency</span><span class="op">.</span><span class="nam">id</span> <span class="op">!=</span> <span class="nam">company_currency</span><span class="op">.</span><span class="nam">id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t961" class="pln"><span class="n"><a href="#t961">961</a></span><span class="t">                    <span class="com"># Statement is in foreign currency but the transaction is in company currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t962" class="mis show_mis"><span class="n"><a href="#t962">962</a></span><span class="t">                    <span class="nam">prorata_factor</span> <span class="op">=</span> <span class="op">(</span><span class="nam">aml_dict</span><span class="op">[</span><span class="str">'debit'</span><span class="op">]</span> <span class="op">-</span> <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'credit'</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount_currency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t963" class="mis show_mis"><span class="n"><a href="#t963">963</a></span><span class="t">                    <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'amount_currency'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">prorata_factor</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">amount</span>&nbsp;</span><span class="r"></span></p>
    <p id="t964" class="mis show_mis"><span class="n"><a href="#t964">964</a></span><span class="t">                    <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'currency_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">statement_currency</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t965" class="pln"><span class="n"><a href="#t965">965</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t966" class="pln"><span class="n"><a href="#t966">966</a></span><span class="t">            <span class="com"># Create write-offs</span>&nbsp;</span><span class="r"></span></p>
    <p id="t967" class="pln"><span class="n"><a href="#t967">967</a></span><span class="t">            <span class="com"># When we register a payment on an invoice, the write-off line contains the amount</span>&nbsp;</span><span class="r"></span></p>
    <p id="t968" class="pln"><span class="n"><a href="#t968">968</a></span><span class="t">            <span class="com"># currency if all related invoices have the same currency. We apply the same logic in</span>&nbsp;</span><span class="r"></span></p>
    <p id="t969" class="pln"><span class="n"><a href="#t969">969</a></span><span class="t">            <span class="com"># the manual reconciliation.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t970" class="mis show_mis"><span class="n"><a href="#t970">970</a></span><span class="t">            <span class="nam">counterpart_aml</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t971" class="mis show_mis"><span class="n"><a href="#t971">971</a></span><span class="t">            <span class="key">for</span> <span class="nam">aml_dict</span> <span class="key">in</span> <span class="nam">counterpart_aml_dicts</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t972" class="mis show_mis"><span class="n"><a href="#t972">972</a></span><span class="t">                <span class="nam">counterpart_aml</span> <span class="op">|=</span> <span class="nam">aml_dict</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'move_line'</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">env</span><span class="op">[</span><span class="str">'account.move.line'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t973" class="mis show_mis"><span class="n"><a href="#t973">973</a></span><span class="t">            <span class="nam">new_aml_currency</span> <span class="op">=</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t974" class="mis show_mis"><span class="n"><a href="#t974">974</a></span><span class="t">            <span class="key">if</span> <span class="nam">counterpart_aml</span><span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t975" class="pln"><span class="n"><a href="#t975">975</a></span><span class="t">                    <span class="key">and</span> <span class="nam">len</span><span class="op">(</span><span class="nam">counterpart_aml</span><span class="op">.</span><span class="nam">mapped</span><span class="op">(</span><span class="str">'currency_id'</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t976" class="pln"><span class="n"><a href="#t976">976</a></span><span class="t">                    <span class="key">and</span> <span class="nam">counterpart_aml</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">currency_id</span><span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p id="t977" class="pln"><span class="n"><a href="#t977">977</a></span><span class="t">                    <span class="key">and</span> <span class="nam">counterpart_aml</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">currency_id</span> <span class="op">!=</span> <span class="nam">company_currency</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t978" class="mis show_mis"><span class="n"><a href="#t978">978</a></span><span class="t">                <span class="nam">new_aml_currency</span> <span class="op">=</span> <span class="nam">counterpart_aml</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">currency_id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t979" class="mis show_mis"><span class="n"><a href="#t979">979</a></span><span class="t">            <span class="key">for</span> <span class="nam">aml_dict</span> <span class="key">in</span> <span class="nam">new_aml_dicts</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t980" class="mis show_mis"><span class="n"><a href="#t980">980</a></span><span class="t">                <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'payment_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">payment</span> <span class="key">and</span> <span class="nam">payment</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t981" class="mis show_mis"><span class="n"><a href="#t981">981</a></span><span class="t">                <span class="key">if</span> <span class="nam">new_aml_currency</span> <span class="key">and</span> <span class="key">not</span> <span class="nam">aml_dict</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'currency_id'</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t982" class="mis show_mis"><span class="n"><a href="#t982">982</a></span><span class="t">                    <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'currency_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">new_aml_currency</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t983" class="mis show_mis"><span class="n"><a href="#t983">983</a></span><span class="t">                    <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'amount_currency'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">company_currency</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">ctx</span><span class="op">)</span><span class="op">.</span><span class="nam">compute</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">[</span><span class="str">'debit'</span><span class="op">]</span> <span class="op">-</span> <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'credit'</span><span class="op">]</span><span class="op">,</span> <span class="nam">new_aml_currency</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t984" class="mis show_mis"><span class="n"><a href="#t984">984</a></span><span class="t">                <span class="nam">aml_obj</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">check_move_validity</span><span class="op">=</span><span class="nam">False</span><span class="op">,</span> <span class="nam">apply_taxes</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t985" class="pln"><span class="n"><a href="#t985">985</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t986" class="pln"><span class="n"><a href="#t986">986</a></span><span class="t">            <span class="com"># Create counterpart move lines and reconcile them</span>&nbsp;</span><span class="r"></span></p>
    <p id="t987" class="mis show_mis"><span class="n"><a href="#t987">987</a></span><span class="t">            <span class="key">for</span> <span class="nam">aml_dict</span> <span class="key">in</span> <span class="nam">counterpart_aml_dicts</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t988" class="mis show_mis"><span class="n"><a href="#t988">988</a></span><span class="t">                <span class="key">if</span> <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'move_line'</span><span class="op">]</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t989" class="mis show_mis"><span class="n"><a href="#t989">989</a></span><span class="t">                    <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'partner_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'move_line'</span><span class="op">]</span><span class="op">.</span><span class="nam">partner_id</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t990" class="mis show_mis"><span class="n"><a href="#t990">990</a></span><span class="t">                <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'account_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'move_line'</span><span class="op">]</span><span class="op">.</span><span class="nam">account_id</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t991" class="mis show_mis"><span class="n"><a href="#t991">991</a></span><span class="t">                <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'payment_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">payment</span> <span class="key">and</span> <span class="nam">payment</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t992" class="pln"><span class="n"><a href="#t992">992</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t993" class="mis show_mis"><span class="n"><a href="#t993">993</a></span><span class="t">                <span class="nam">counterpart_move_line</span> <span class="op">=</span> <span class="nam">aml_dict</span><span class="op">.</span><span class="nam">pop</span><span class="op">(</span><span class="str">'move_line'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t994" class="mis show_mis"><span class="n"><a href="#t994">994</a></span><span class="t">                <span class="key">if</span> <span class="nam">counterpart_move_line</span><span class="op">.</span><span class="nam">currency_id</span> <span class="key">and</span> <span class="nam">counterpart_move_line</span><span class="op">.</span><span class="nam">currency_id</span> <span class="op">!=</span> <span class="nam">company_currency</span> <span class="key">and</span> <span class="key">not</span> <span class="nam">aml_dict</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'currency_id'</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t995" class="mis show_mis"><span class="n"><a href="#t995">995</a></span><span class="t">                    <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'currency_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">counterpart_move_line</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p id="t996" class="mis show_mis"><span class="n"><a href="#t996">996</a></span><span class="t">                    <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'amount_currency'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">company_currency</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">ctx</span><span class="op">)</span><span class="op">.</span><span class="nam">compute</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">[</span><span class="str">'debit'</span><span class="op">]</span> <span class="op">-</span> <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'credit'</span><span class="op">]</span><span class="op">,</span> <span class="nam">counterpart_move_line</span><span class="op">.</span><span class="nam">currency_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t997" class="mis show_mis"><span class="n"><a href="#t997">997</a></span><span class="t">                <span class="nam">new_aml</span> <span class="op">=</span> <span class="nam">aml_obj</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">check_move_validity</span><span class="op">=</span><span class="nam">False</span><span class="op">)</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t998" class="pln"><span class="n"><a href="#t998">998</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t999" class="mis show_mis"><span class="n"><a href="#t999">999</a></span><span class="t">                <span class="op">(</span><span class="nam">new_aml</span> <span class="op">|</span> <span class="nam">counterpart_move_line</span><span class="op">)</span><span class="op">.</span><span class="nam">reconcile</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t1000" class="pln"><span class="n"><a href="#t1000">1000</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t1001" class="pln"><span class="n"><a href="#t1001">1001</a></span><span class="t">            <span class="com"># Balance the move</span>&nbsp;</span><span class="r"></span></p>
    <p id="t1002" class="mis show_mis"><span class="n"><a href="#t1002">1002</a></span><span class="t">            <span class="nam">st_line_amount</span> <span class="op">=</span> <span class="op">-</span><span class="nam">sum</span><span class="op">(</span><span class="op">[</span><span class="nam">x</span><span class="op">.</span><span class="nam">balance</span> <span class="key">for</span> <span class="nam">x</span> <span class="key">in</span> <span class="nam">move</span><span class="op">.</span><span class="nam">line_ids</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t1003" class="mis show_mis"><span class="n"><a href="#t1003">1003</a></span><span class="t">            <span class="nam">aml_dict</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_prepare_reconciliation_move_line</span><span class="op">(</span><span class="nam">move</span><span class="op">,</span> <span class="nam">st_line_amount</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t1004" class="mis show_mis"><span class="n"><a href="#t1004">1004</a></span><span class="t">            <span class="nam">aml_dict</span><span class="op">[</span><span class="str">'payment_id'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">payment</span> <span class="key">and</span> <span class="nam">payment</span><span class="op">.</span><span class="nam">id</span> <span class="key">or</span> <span class="nam">False</span>&nbsp;</span><span class="r"></span></p>
    <p id="t1005" class="mis show_mis"><span class="n"><a href="#t1005">1005</a></span><span class="t">            <span class="nam">aml_obj</span><span class="op">.</span><span class="nam">with_context</span><span class="op">(</span><span class="nam">check_move_validity</span><span class="op">=</span><span class="nam">False</span><span class="op">)</span><span class="op">.</span><span class="nam">create</span><span class="op">(</span><span class="nam">aml_dict</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t1006" class="pln"><span class="n"><a href="#t1006">1006</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t1007" class="mis show_mis"><span class="n"><a href="#t1007">1007</a></span><span class="t">            <span class="nam">move</span><span class="op">.</span><span class="nam">post</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t1008" class="pln"><span class="n"><a href="#t1008">1008</a></span><span class="t">            <span class="com">#record the move name on the statement line to be able to retrieve it in case of unreconciliation</span>&nbsp;</span><span class="r"></span></p>
    <p id="t1009" class="mis show_mis"><span class="n"><a href="#t1009">1009</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'move_name'</span><span class="op">:</span> <span class="nam">move</span><span class="op">.</span><span class="nam">name</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t1010" class="mis show_mis"><span class="n"><a href="#t1010">1010</a></span><span class="t">            <span class="nam">payment</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="op">{</span><span class="str">'payment_reference'</span><span class="op">:</span> <span class="nam">move</span><span class="op">.</span><span class="nam">name</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t1011" class="mis show_mis"><span class="n"><a href="#t1011">1011</a></span><span class="t">        <span class="key">elif</span> <span class="nam">self</span><span class="op">.</span><span class="nam">move_name</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t1012" class="mis show_mis"><span class="n"><a href="#t1012">1012</a></span><span class="t">            <span class="key">raise</span> <span class="nam">UserError</span><span class="op">(</span><span class="nam">_</span><span class="op">(</span><span class="str">'Operation not allowed. Since your statement line already received a number, you cannot reconcile it entirely with existing journal entries otherwise it would make a gap in the numbering. You should book an entry and make a regular revert of it in case you want to cancel it.'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t1013" class="mis show_mis"><span class="n"><a href="#t1013">1013</a></span><span class="t">        <span class="nam">counterpart_moves</span><span class="op">.</span><span class="nam">assert_balanced</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t1014" class="mis show_mis"><span class="n"><a href="#t1014">1014</a></span><span class="t">        <span class="key">return</span> <span class="nam">counterpart_moves</span>&nbsp;</span><span class="r"></span></p>
</div>
<div id="footer">
    <div class="content">
        <p>
            <a class="nav" href="index.html">&#xab; index</a> &nbsp; &nbsp; <a class="nav" href="https://coverage.readthedocs.io">coverage.py v5.4</a>,
            created at 2021-02-24 19:43
        </p>
    </div>
</div>
</body>
</html>
